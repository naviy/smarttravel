using System;
using System.Collections.Generic;
using System.Linq;

using Luxena.Travel.Domain;
using Luxena.Travel.Parsers;

using NUnit.Framework;


namespace Luxena.Travel.Tests.Parsers
{
	[TestFixture]
	public class IataParserTests
	{
		#region Parse Ticket


		[Test]
		public void TestParseTicketFares01()
		{

			ParseTicket(
@"AIR-BLK207;7A;;247;1200023812;1A1326991;001001
AMD 1203277023;1/1;              
GW3671466;1A1326991;IEV1A0985;AIR
MUC1A 2KM2X9006;0101;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;LY 2KM2X9
A-EL AL ISRAEL AIRLINES;LY 1142
B-TTP
C-7906/ 2106TDSU-2106TDSU-F-N--
D-130212;130212;130212
G-X  ;;IEVIEV;
H-003;002OKBP;KIEV BORYSPIL    ;TLV;TEL AVIV B GURION;LY    0652 G G 14FEB2255 0215 15FEB;OK01;HK01;S ;0;738;M;;1PC;B ;;ET;0320 ;N;1284;UA;IL;3 
H-004;003OTLV;TEL AVIV B GURION;KBP;KIEV BORYSPIL    ;LY    0651 G G 17FEB1830 2155 17FEB;OK01;HK01;S ;0;738;M;;1PC;3 ;;ET;0325 ;N;1284;IL;UA;B 
K-
KN-IUSD279.00     ;UAH2230       ;;;;;;;;;;;UAH2735       ;UAH320        ;7.9930     ;;   
KNTI; UAH136      YK AE; UAH16       UD DP; UAH32       UA SE; UAH193      IL EB; UAH128      AP SE;;;;;;;;;;;;;;;;;;;;;;;;;
KS-IUSD279.00     ;UAH2230       ;;;;;;;;;;;UAH2735       ;7.9930     ;;   
KSTI; UAH136      YK AE; UAH16       UD DP; UAH32       UA SE; UAH193      IL EB; UAH128      AP SE;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH353      XT ;
SIAI;;IT     
L-
M-GUAJC1         ;GUAJC1         
N-;;;
O-14FEB14FEB;17FEB17FEB
Q-IEV LY TLV Q122.00 M/IT LY IEV Q122.00 M/IT END XT32UA193IL128AP;FXB/R,U*UAJ00
I-001;01LESHCHENKO/INGA MRS;;APIEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
T-K114-3232118156
FEFARE RESTRICTIONS APPLY;S2-3;P1
FM*F*0.00;S2-3;P1
FPCASH
FV*F*LY;S2-3;P1
TKTL12FEB/IEVUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
RII2935 UAH
ENDX"
			);

			AssertFareSegments(
				0, "",
				a => a("KBP", "LY", "TLV", surcharges: 122, isInclusive: true),
				a => a("TLV", "LY", "KBP", surcharges: 122, isInclusive: true)
			);

			ticket.Total = new Money("UAH", 1000);
			//CalculateFareSegments(25, 75);
			AssertFareSegmentAmounts(279 * .25m, 279 * .75m);
		}

		[Test]
		public void TestParseTicketFares02()
		{
			ParseTicket(
@"AIR-BLK207;7A;;233;2400055672;1A1326991;001001
AMD 2403516093;1/1;              
1A1119395;1A1326991;IEV1A0985;AIR
MUC1A 5HBRE4023;0303;IEVU23246;;IEVU23246;;IEVU23246;;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;AY 5HBRE4;PS RWSRN 
A-FINNAIR;AY 1050
B-TTP
C-7906/ 0001AASU-9999WSSU-I-0--
D-130423;130424;130424
G-X  ;;IEVIEV;
H-005;004OKBP;KIEV BORYSPIL    ;HEL;HELSINKI         ;PS    0151 V V 14MAY1050 1255 14MAY;OK03;HK03;S ;0;A81;;;1PC;F ;;ET;0205 ;N;728;UA;FI;2 
H-006;005XHEL;HELSINKI         ;PEK;BEIJING CAPITAL  ;AY    0051 R R 14MAY1805 0655 15MAY;OK03;HK03;BD;0;333;M;;1PC;2 ;;ET;0750 ;N;3932;FI;CN;3 
H-000;000OPEK;BEIJING CAPITAL  ;HKG;HONG KONG        ;VOID;CN;HK
H-008;007OHKG;HONG KONG        ;HEL;HELSINKI         ;AY    0070 R R 24MAY0025 0610 24MAY;OK03;HK03;BS;0;340;M;;1PC;1 ;2325 ;ET;1045 ;N;4868;HK;FI;2 
H-001;008XHEL;HELSINKI         ;KBP;KIEV BORYSPIL    ;PS    0152 V V 24MAY1555 1800 24MAY;OK03;HK03;S ;0;A81;;;1PC;2 ;;ET;0205 ;N;728;FI;UA;F 
K-FUSD274.00     ;UAH2190       ;;;;;;;;;;;UAH6719       ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH880      YQ AC; UAH3134     YR VA; UAH32       UA SE; UAH90       DQ AP; UAH13       XU AV; UAH104      WL CO; UAH124      HK AE;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH4377     XT ;
L-
M-RLECO          ;RLECO          ;RLECO          ;RLECO          
N-NUC;120.00;VOID;;150.00
O-14MAY14MAY;14MAY14MAY;24MAY24MAY;24MAY24MAY
Q-IEV PS X/HEL AY BJS120.00/-HKG AY X/HEL Q4.25PS IEV150.00NUC274.25END ROE1.000000XT880YQ3134YR32UA90DQ13XU104WL124HK;FXP
I-001;01KANIVETS/MYKOLA MR;;APIEV 38044-449 9860 - ZLM - A;;
SSR OTHS 1A  /AUTO XX IF SSR TKNA/E/M/C NOT RCVD BY 1732/26APR/IEV LT
SSR OTHS 1A  /AY RESERVES THE RIGHT TO AUTOCANCEL OR SEND ADM
SSR OTHS 1A  /IF NO TKT IS ISSUED BY 25APR2013/2359 IEV TIME
SSR OTHS 1A  /TIMELIMIT FOR THIS PNR WILL NOT
SSR OTHS 1A  /CHANGE IF REBOOKED. FARE RULES STILL APPLY
SSR DOCS PS  HK1/P/UKR/EP831339/UKR/23OCT65/M/13MAR23/KANIVETS/MYKOLA/H;P1
SSR DOCS AY  HK1/P/UKR/EP831339/UKR/23OCT65/M/13MAR23/KANIVETS/MYKOLA/H;P1
T-K105-3532575086-87
FEREFUND/CHANGES RESTRICTED/;S4-5,7-8;P1-3
FM*M*1A
FPCASH
FVAY;S4-5,7-8;P1-3
TKTL24APR/IEVU23246
I-002;02NEYCHEV/IGOR MR;;APIEV 38044-449 9860 - ZLM - A;;
SSR OTHS 1A  /AUTO XX IF SSR TKNA/E/M/C NOT RCVD BY 1732/26APR/IEV LT
SSR OTHS 1A  /AY RESERVES THE RIGHT TO AUTOCANCEL OR SEND ADM
SSR OTHS 1A  /IF NO TKT IS ISSUED BY 25APR2013/2359 IEV TIME
SSR OTHS 1A  /TIMELIMIT FOR THIS PNR WILL NOT
SSR OTHS 1A  /CHANGE IF REBOOKED. FARE RULES STILL APPLY
SSR DOCS PS  HK1/P/UKR/AK024737/UKR/18JAN67/M/01MAR14/NEYCHEV/IGOR/H;P2
SSR DOCS AY  HK1/P/UKR/AK024737/UKR/18JAN67/M/01MAR14/NEYCHEV/IGOR/H;P2
T-K105-3532575088-89
FEREFUND/CHANGES RESTRICTED/;S4-5,7-8;P1-3
FM*M*1A
FPCASH
FVAY;S4-5,7-8;P1-3
TKTL24APR/IEVU23246
I-003;03SCHASTNYI/OLEKSANDR MR;;APIEV 38044-449 9860 - ZLM - A;;
SSR OTHS 1A  /AUTO XX IF SSR TKNA/E/M/C NOT RCVD BY 1732/26APR/IEV LT
SSR OTHS 1A  /AY RESERVES THE RIGHT TO AUTOCANCEL OR SEND ADM
SSR OTHS 1A  /IF NO TKT IS ISSUED BY 25APR2013/2359 IEV TIME
SSR OTHS 1A  /TIMELIMIT FOR THIS PNR WILL NOT
SSR OTHS 1A  /CHANGE IF REBOOKED. FARE RULES STILL APPLY
SSR DOCS PS  HK1/P/UKR/EE920555/UKR/19FEB59/M/06FEB19/SCHASTNYI/OLEKSANDR/H;P3
SSR DOCS AY  HK1/P/UKR/EE920555/UKR/19FEB59/M/06FEB19/SCHASTNYI/OLEKSANDR/H;P3
T-K105-3532575090-91
FEREFUND/CHANGES RESTRICTED/;S4-5,7-8;P1-3
FM*M*1A
FPCASH
FVAY;S4-5,7-8;P1-3
TKTL24APR/IEVU23246
RIITICKET PRICE 7054 UAH
ENDX"
			);

			AssertFareSegments(
				274.25m, "NUC",
				a => a("KBP", "PS", "HEL"),
				a => a("HEL", "AY", "PEK", 120.00m),
				a => a("HKG", "AY", "HEL", null, 4.25m),
				a => a("HEL", "PS", "KBP", 150m)
			);

			//CalculateFareSegments(100, 100, 25, 75);
			AssertFareSegmentAmounts(60m, 60m, 150m * 0.25m + 4.25m, 150m * 0.75m);
		}

		[Test]
		public void TestParseTicketFares03()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;0200005198;1A1326991;001001
AMD 0203154595;1/1;              
GW3673280;1A1326991;IEV1A0985;AIR
MUC1A 7SVVH3005;0101;VSGUW2100;72321314;VSGUW2100;72321314;VSGUW2100;72321314;VSGUW2100;72321314;;;;;;;;;;;;;;;;;;;;;;QU 4736C4
A-AIRLINE UTAIR UKRAINE;QU 7615
B-TTP
C-7906/ 0013LBSU-0013LBSU-M-E--
D-130101;130102;130102
G-   ;;VSGLWO;UA
H-001;002OVSG;LUHANSK INTL     ;IEV;KIEV ZHULIANY INT;QU    0507 V V 03JAN0700 0900 03JAN;OK01;HK01;;0;AT4;;;15K;;;ET;0200 ; ;419;UA;UA;B 
H-002;003OIEV;KIEV ZHULIANY INT;LWO;LVIV INTL        ;QU    0502 V V 03JAN1000 1130 03JAN;OK01;HK01;;0;AT7;;;15K;A ;;ET;0130 ; ;292;UA;UA;A 
K-FUSD162.00     ;UAH1295       ;;;;;;;;;;;UAH1817       ;7.9930     ;;   
KFTF; UAH282      HF GO; UAH8        UD DP; UAH128      YQ AC; UAH72       YK AE; UAH32       UA SE;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH282      HF ;UAH8        UD ;UAH232      XT ;
L-
M-VOW      KK5   ;VOW      KK5   
N-USD76.00;85.50
O-03JAN03JAN;03JAN03JAN
Q-VSG QU IEV76.00QU LWO85.50USD161.50END XT128YQ72YK32UA;FXP/ZO-5P*KK5
I-001;01ANTONETS/GALYNA MRS;;AP0503288821;;
SSR ADTK 1A  /QU-0507/03JAN13 BY 02JAN/0946Z OR CNL
SSR ADTK 1A  /QU-0502/03JAN13 BY 02JAN/0946Z OR CNL
T-K761-2576179656
FENONENDO/NONREF/REBKRESTR;S2-3;P1
FM*M*5
FPCASH
FTQU000X/12
FVQU;S2-3;P1
TKOK02JAN/VSGUW2100
ENDX"
			);
			AssertFareSegments(
				161.50m, "USD",
				a => a("VSG", "QU", "IEV", 76.00m),
				a => a("IEV", "QU", "LWO", 85.50m)
			);

			//CalculateFareSegments(100, 100);
			AssertFareSegmentAmounts(76.00m, 85.50m);
		}

		[Test]
		public void TestParseTicketFares04()
		{
			ParseTicket(
@"AIR-BLK207;7A;;233;2800035138;1A1326991;001001
AMD 2803148809;1/1;              
1A1133820;1A1326991;IEV1A0985;AIR
MUC1A 6GAXR2015;0303;HRKU23197;;HRKU23197;;HRKU23197;;HRKUW2100;72321255;;;;;;;;;;;;;;;;;;;;;;LH 6GAXR2;OS 6GAXR2
A-AUSTRIAN AIRLINES;OS 2575
B-TTP
C-7906/ 0001AASU-9999WSSU-I-0--
D-121227;121228;121228
G-X  ;;IEVIEV;E1
H-001;004OKBP;KIEV BORYSPIL    ;VIE;VIENNA SCHWECHAT ;OS    0662 K K 27JAN1330 1430 27JAN;OK03;HK03;S ;0;319;;TYROLEAN AIRWAYS;1PC;D ;1230 ;ET;0200 ;N;667;UA;AT;  
Y-001;004KBP;KIEV BORYSPIL;VIE;VIENNA SCHWECHAT;VO;TYROLEAN AIRWAYS;;;;;319;N
H-002;005XVIE;VIENNA SCHWECHAT ;BLQ;BOLOGNA          ;OS    0549 K K 27JAN1745 1905 27JAN;OK03;HK03;S ;0;F70;;TYROLEAN AIRWAYS;1PC;;1700 ;ET;0120 ;N;353;AT;IT;  
Y-002;005VIE;VIENNA SCHWECHAT;BLQ;BOLOGNA;VO;TYROLEAN AIRWAYS;;;;;F70;N
H-000;000OBLQ;BOLOGNA          ;DUS;DUESSELDORF      ;VOID;IT;DE
H-003;006ODUS;DUESSELDORF      ;KBP;KIEV BORYSPIL    ;LH    3004 E E 04FEB1125 1505 04FEB;OK03;HK03;S ;0;CR9;;EUROWINGS;1PC;;;ET;0240 ; ;1055;DE;UA;D 
Y-003;006DUS;DUESSELDORF;KBP;KIEV BORYSPIL;EW;EUROWINGS;;;;;CR9;N
K-FUSD88.00      ;UAH704        ;;;;;;;;;;;UAH2069       ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH606      YQ AC; UAH32       UA SE; UAH190      ZY AE; UAH82       AT SE; UAH80       OY CB; UAH179      RA EB; UAH44       DE SE;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH1213     XT ;
L-*OS *
M-KBUYOS1U       ;KBUYOS1U       ;ENN04NW3       
N-NUC;37.00;VOID;50.50
O-27JAN27JAN;27JAN27JAN;04FEB04FEB
Q-IEV OS X/VIE OS BLQ37.00/-DUS LH IEV50.50NUC87.50END ROE1.000000XT606YQ32UA190ZY82AT80OY179RA44DE;FXP/R,UP,VC-OS
I-003;01MESHKOVA/GANNA MRS;;APHRK +380509582952 - ROMANTIC TRAVEL - A;;
SSR OTHS 1A  /PLS ISS AUTOMATIC TKT BY 28DEC12/2359Z OR ALL LH SEGS WILL BE XLD. APPLICABLE FARE RULE APPLIES IF IT
SSR OTHS 1A  ////DEMANDS EARLIER TKTG.XE/I FF
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 29DEC12 1025GMT OR SEG WILL BE CANX
T-K257-2576203954
FENONREF/NO CHNGS NONENDO;S4-6;P1-3
FM*M*1A
FPCASH
FVOS;S4-6;P1-3
TKTL28DEC/HRKU23197
I-001;02SEVASTYANOVA/OLGA MRS;;APHRK +380509582952 - ROMANTIC TRAVEL - A;;
SSR OTHS 1A  /PLS ISS AUTOMATIC TKT BY 28DEC12/2359Z OR ALL LH SEGS WILL BE XLD. APPLICABLE FARE RULE APPLIES IF IT
SSR OTHS 1A  ////DEMANDS EARLIER TKTG.XE/I FF
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 29DEC12 1025GMT OR SEG WILL BE CANX
T-K257-2576203955
FENONREF/NO CHNGS NONENDO;S4-6;P1-3
FM*M*1A
FPCASH
FVOS;S4-6;P1-3
TKTL28DEC/HRKU23197
I-002;03ZHYKHARIEVA/SVITLANA MRS;;APHRK +380509582952 - ROMANTIC TRAVEL - A;;
SSR OTHS 1A  /PLS ISS AUTOMATIC TKT BY 28DEC12/2359Z OR ALL LH SEGS WILL BE XLD. APPLICABLE FARE RULE APPLIES IF IT
SSR OTHS 1A  ////DEMANDS EARLIER TKTG.XE/I FF
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 29DEC12 1025GMT OR SEG WILL BE CANX
T-K257-2576203956
FENONREF/NO CHNGS NONENDO;S4-6;P1-3
FM*M*1A
FPCASH
FVOS;S4-6;P1-3
TKTL28DEC/HRKU23197
ENDX"
			);
			AssertFareSegments(
				87.50m, "NUC",
				a => a("KBP", "OS", "VIE"),
				a => a("VIE", "OS", "BLQ", 37.00m),
				a => a("DUS", "LH", "KBP", 50.50m)
			);

			ticket.Total = new Money("UAH", 1000);
			//CalculateFareSegments(0, 25, 75);
			AssertFareSegmentAmounts(0.00m, 37.00m, 50.50m);
		}

		//		[Test]
		//		public void TestParseTicketFares05()
		//		{
		//			ParseTicket(
		//@"AIR-BLK207;7A;;247;0900035570;1A1326991;001001
		//AMD 0903170863;1/1;              
		//GW3672914;1A1326991;IEV1A0985;AIR
		//MUC1A 448XQ9052;0201;DNKUW2100;72320662;DNKUW2100;72320662;DNKUW2100;72320662;DNKUW2100;72320662;;;;;;;;;;;;;;;;;;;;;;VV 448XQ9
		//A-AEROSVIT AIRLINES;VV 8702
		//B-TTP/T2
		//C-7906/ 2803GOSU-1611HVSU-M-1--
		//D-120813;130109;130109
		//G-X  ;;DNKTLV;
		//H-004;004ODNK;DNIPROPETROVSK   ;KBP;KIEV BORYSPIL    ;VV    4002 K K 23JAN0720 0820 23JAN;OK01;HK01;N ;0;735;;;20K;;;ET;0100 ;N;226;UA;UA;B 
		//X-004;004ODNK;DNIPROPETROVSK   ;KBP;KIEV BORYSPIL    ;PS    0072 K K 23JAN0720 0820 23JAN;OK01;HK01;N ;0;735;;;20K;;;ET;0100 ;N;B 
		//H-005;005OKBP;KIEV BORYSPIL    ;TLV;TEL AVIV B GURION;VV    4775 K K 23JAN0950 1305 23JAN;OK01;HK01;L ;0;737;;;20K;F ;;ET;0315 ;N;1284;UA;IL;3 
		//X-005;005OKBP;KIEV BORYSPIL    ;TLV;TEL AVIV B GURION;PS    0775 K K 23JAN0950 1305 23JAN;OK01;HK01;L ;0;737;;;20K;F ;;ET;0315 ;N;3 
		//K-RUSD369.00     ;UAH           ;;;;;;;;;;;UAH0          ;;;   
		//KFTR;OUAH88       YK   ;OUAH16       UD   ;OUAH640      YQ   ;OUAH201      IL   ;;;;;;;;;;;;;;;;;;;;;;;;;;
		//TAX-PD 88       YK ;PD 16       UD ;PD 841      XT ;
		//L-
		//M-KPX1Y5ZZ25     ;KPX1Y5ZZ25     
		//O-23JAN23JAN;23JAN23JAN
		//Q-I-TLV VV DNK Q70.00 114.37VV TLV Q70.00 114.37NUC368.74END ROE1.000000PD XT640YQ201IL;
		//I-002;02MAATUF /OR CHANA MS(YTH);;APDNK 38 056 7702071 - UNIVERSAL FLIGHTS SALES AGENCY - A//0676799770 C/O YACOV//E YASHENKA770@GMAIL.COM;;
		//SSR KSML VV  HK2/;S5
		//SSR OTHS 1A  /ADTK BY 1700 LOCAL TIME/21AUG2012 OR SPACE WILL BE CXLD
		//SSR OTHS 1A  /ATTN SCHEDULE CHANG PLS INFO PAX
		//T-K870-2576235033
		//FH870-2084944416;P2
		//FE.-50515032.-/NONENDO/REF/REBOOK RESTR/INVOL REISSUE DUE VV243 22JAN CNLD
		//FM*M*1
		//FO870-2084944416DNK14AUG12/72320662/870-20849444162E2;P2
		//FPO/CASH+/CASH
		//FVVV
		//TKOK14AUG/DNKUW2100//ETVV
		//RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
		//RM !DO NOT FORGET TO CHNG ENDORSEMENT! FE.-50515032.-/
		//RM 2003 VV ARI CONTROL AUTO 1700/13AUG2012 - SET 08/06/12 1023
		//RM 2003 VV ARI CONTROL AUTO 1700/21AUG2012 - SET 08/13/12 1700
		//RIZTICKET FARE UAH 2950.00
		//RIZTICKET TAX UAH 957.00
		//RIZTICKET TTL UAH 3907.00
		//RIZSERVICE FEE UAH 133.33+VAT 26.67
		//RIZGRAND TOTAL UAH 4067.00
		//ENDX"
		//			);
		//			AssertFareSegments(
		//				368.74m, "NUC",
		//				a => a("TLV", "VV", "DNK", 114.37m, 70.00m),
		//				a => a("DNK", "VV", "TLV", 114.37m, 70.00m)
		//			);
		//			CalculateFareSegments(100, 100);
		//			AssertFareSegmentAmounts(114.37m + 70m, 114.37m + 70m);
		//		}


		[Test]
		public void TestParseTicketFares06()
		{
			ParseTicket(
@"AIR-BLK207;7A;;243;0500044754;1A1326991;001001
AMD 0503080086;1/1;              
GW3671464;1A1326991;IEV1A0985;AIR
MUC1A 5SIJ2I009;0101;IEVU22175;;IEVU22175;;IEVU22175;;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;CA MJ8NFQ;EK HMSPNJ;PS R64R6 
A-EMIRATES;EK 1761
B-TTP/ET/RT/T4
C-7906/ 3011OKSU-1701GTSU-I-0--
D-121205;121205;121205
G-X  ;;IEVIEV;
H-001;002OKBP;KIEV BORYSPIL    ;DXB;DUBAI            ;PS    0373 N N 11DEC2020 0315 12DEC;OK01;HK01;D ;0;738;;;30K;F ;;ET;0455 ;N;2166;UA;AE;1 
H-002;003XDXB;DUBAI            ;HKG;HONG KONG        ;EK    0380 U U 12DEC1005 2105 12DEC;OK01;HK01;M ;0;77W;;;30K;3 ;;ET;0700 ;N;3703;AE;HK;1 
H-005;006OHKG;HONG KONG        ;DXB;DUBAI            ;EK    0383 U U 06SEP1905 2310 06SEP;OK01;HK01;M ;0;77W;;;30K;1 ;;ET;0805 ;N;3703;HK;AE;3 
H-006;007XDXB;DUBAI            ;KBP;KIEV BORYSPIL    ;PS    0374 N N 07SEP0320 0740 07SEP;OK01;HK01;M ;0;738;;;30K;1 ;;ET;0520 ;N;2166;AE;UA;F 
U-008X;004OHKG;HONG KONG        ;TPE;TAIPEI           ;HX    0284 N N 12DEC2330 0115 13DEC;OK01;HK01;S ;0;332;;;;1 ;;ET;0145 ; ;;484;;HK;TW;2 
U-007X;005OTPE;TAIPEI           ;HKG;HONG KONG        ;HX    0265 L L 06SEP1445 1640 06SEP;OK01;HK01;S ;0;332;;;;2 ;;ET;0155 ; ;;484;;TW;HK;1 
K-FUSD717.00     ;UAH5731       ;;;;;;;;;;;UAH6039       ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH32       UA SE; UAH124      HK AE;;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH156      XT ;
L-*EK *
M-UEE1YRU1       ;UEE1YRU1       ;UEE1YRU1       ;UEE1YRU1       
N-NUC;356.17;;300.50
O-11DEC11DEC;12DEC12DEC;06SEP06SEP;07SEP07SEP
Q-IEV PS X/DXB EK HKG Q55.67 300.50EK X/DXB Q55.67 Q4.25PS IEV300.50NUC716.59END ROE1.000000XT32UA124HK;FXB/S2-3,6-7/R,VC-EK
I-001;01KONOVALOV/SVIATOSLAV MR;;APIEV +38044 360 30 00 - PERSEY TRAVEL - A//ASIA//IEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A//E_______OLEG@PERSEYTRAVEL.COM.UA;;
T-K176-2576112425
FENON-END/SKYWARDS SAVER/ VALID ON EK/WPID6497;S2-3,6-7;P1
FM*M*5
FPINVOICE
FVEK;S2-3,6-7;P1
AM24SEPTPEHKG/AHX
TKTL08DEC/IEVU22175
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX"
			);
			AssertFareSegments(
				716.59m, "NUC",
				a => a("KBP", "PS", "DXB"),
				a => a("DXB", "EK", "HKG", 300.50m, 55.67m),
				a => a("HKG", "EK", "DXB", surcharges: 55.67m + 4.25m),
				a => a("DXB", "PS", "KBP", 300.50m)
			);

			//CalculateFareSegments(25, 75, 50, 50);
			AssertFareSegmentAmounts(
				300.50m * 0.25m - 0.005m,
				300.50m * 0.75m + 55.67m + 0.005m,
				300.50m * 0.5m + 55.67m + 4.25m,
				300.50m * 0.5m
			);
		}

		[Test]
		public void TestParseTicketFares06a()
		{
			ParseTicket(
@"AIR-BLK207;7A;;243;0500044754;1A1326991;001001
AMD 0503080086;1/1;              
GW3671464;1A1326991;IEV1A0985;AIR
MUC1A 5SIJ2I009;0101;IEVU22175;;IEVU22175;;IEVU22175;;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;CA MJ8NFQ;EK HMSPNJ;PS R64R6 
A-EMIRATES;EK 1761
B-TTP/ET/RT/T4
C-7906/ 3011OKSU-1701GTSU-I-0--
D-121205;121205;121205
G-X  ;;IEVIEV;
H-001;002OKBP;KIEV BORYSPIL    ;DXB;DUBAI            ;PS    0373 N N 11DEC2020 0315 12DEC;OK01;HK01;D ;0;738;;;30K;F ;;ET;0455 ;N;2166;UA;AE;1 
H-002;003XDXB;DUBAI            ;HKG;HONG KONG        ;EK    0380 U U 12DEC1005 2105 12DEC;OK01;HK01;M ;0;77W;;;30K;3 ;;ET;0700 ;N;3703;AE;HK;1 
H-005;006OHKG;HONG KONG        ;DXB;DUBAI            ;EK    0383 U U 06SEP1905 2310 06SEP;OK01;HK01;M ;0;77W;;;30K;1 ;;ET;0805 ;N;3703;HK;AE;3 
H-006;007XDXB;DUBAI            ;KBP;KIEV BORYSPIL    ;PS    0374 N N 07SEP0320 0740 07SEP;OK01;HK01;M ;0;738;;;30K;1 ;;ET;0520 ;N;2166;AE;UA;F 
U-008X;004OHKG;HONG KONG        ;TPE;TAIPEI           ;HX    0284 N N 12DEC2330 0115 13DEC;OK01;HK01;S ;0;332;;;;1 ;;ET;0145 ; ;;484;;HK;TW;2 
U-007X;005OTPE;TAIPEI           ;HKG;HONG KONG        ;HX    0265 L L 06SEP1445 1640 06SEP;OK01;HK01;S ;0;332;;;;2 ;;ET;0155 ; ;;484;;TW;HK;1 
K-FUSD717.00     ;UAH5731       ;;;;;;;;;;;UAH6039       ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH32       UA SE; UAH124      HK AE;;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH156      XT ;
L-*EK *
M-UEE1YRU1       ;UEE1YRU1       ;UEE1YRU1       ;UEE1YRU1       
N-NUC;356.17;;300.50
O-11DEC11DEC;12DEC12DEC;06SEP06SEP;07SEP07SEP
Q-IEV PS X/DXB EK HKG Q55.67 300.50EK X/DXB Q55.67 Q4.25PS IEV NUC716.59END ROE1.000000XT32UA124HK;FXB/S2-3,6-7/R,VC-EK
I-001;01KONOVALOV/SVIATOSLAV MR;;APIEV +38044 360 30 00 - PERSEY TRAVEL - A//ASIA//IEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A//E_______OLEG@PERSEYTRAVEL.COM.UA;;
T-K176-2576112425
FENON-END/SKYWARDS SAVER/ VALID ON EK/WPID6497;S2-3,6-7;P1
FM*M*5
FPINVOICE
FVEK;S2-3,6-7;P1
AM24SEPTPEHKG/AHX
TKTL08DEC/IEVU22175
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX"
			);
			AssertFareSegments(
				716.59m, "NUC",
				a => a("KBP", "PS", "DXB"),
				a => a("DXB", "EK", "HKG", 300.50m, 55.67m),
				a => a("HKG", "EK", "DXB", surcharges: 55.67m + 4.25m),
				a => a("DXB", "PS", "KBP")
			);

			//CalculateFareSegments(25, 75, 50, 50);
			AssertFareSegmentAmounts(
				300.50m * 0.25m - 0.005m,
				300.50m * 0.75m + 55.67m + 0.005m,
				(716.59m - 55.67m - 55.67m - 4.25m - 300.50m) * 0.5m + 55.67m + 4.25m,
				(716.59m - 55.67m - 55.67m - 4.25m - 300.50m) * 0.5m
			);
		}

		[Test]
		public void TestParseTicketFares07()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;1600025724;1A1326991;001001
AMD 1603192593;1/1;              
GW3673251;1A1326991;IEV1A0985;AIR
MUC1A 8VNQ7U044;0201;ODSUW2100;72321244;ODSUW2100;72321244;ODSUW2100;72321244;ODSUW2100;72321244;;;;;;;;;;;;;;;;;;;;;;OS 8VNQ7U
A-AUSTRIAN AIRLINES;OS 2575
B-TTP/RT/T10
C-7906/ 3008KLSU-1965MGSU-M-1--
D-120822;130116;130116
G-X  ;;ODSODS;E1
H-009;003OODS;ODESA            ;VIE;VIENNA SCHWECHAT ;OS    7176 C C 16JAN1500 1600 16JAN;OK01;HK01;;0;735;;;2PC;;1400 ;ET;0200 ;N;670;UA;AT;  
X-009;003OODS;ODESA            ;VIE;VIENNA SCHWECHAT ;PS    0820 D C 16JAN1500 1600 16JAN;OK01;HK01;;0;735;;;2PC;;1400 ;ET;0200 ;N;  
Y-009;003ODS;ODESA;VIE;VIENNA SCHWECHAT;PS;UKRAINE INTL AIRLINES;;;;;735;N
H-010;004OVIE;VIENNA SCHWECHAT ;SZG;SALZBURG MOZART  ;OS    0923 C C 16JAN1715 1805 16JAN;OK01;HK01;S ;0;DH4;;TYROLEAN AIRWAYS;2PC;;1645 ;ET;0050 ;N;166;AT;AT;  
Y-010;004VIE;VIENNA SCHWECHAT;SZG;SALZBURG MOZART;VO;TYROLEAN AIRWAYS;;;;;DH4;N
H-011;005OSZG;SALZBURG MOZART  ;VIE;VIENNA SCHWECHAT ;OS    0920 C C 31JAN0820 0920 31JAN;OK01;HK01;B ;0;DH4;;TYROLEAN AIRWAYS;2PC;;0750 ;ET;0100 ;N;166;AT;AT;  
Y-011;005SZG;SALZBURG MOZART;VIE;VIENNA SCHWECHAT;VO;TYROLEAN AIRWAYS;;;;;DH4;N
H-012;006OVIE;VIENNA SCHWECHAT ;ODS;ODESA            ;OS    7175 C C 31JAN1040 1340 31JAN;OK01;HK01;;0;735;;;2PC;;0955 ;ET;0200 ;N;670;AT;UA;  
X-012;006OVIE;VIENNA SCHWECHAT ;ODS;ODESA            ;PS    0819 D C 31JAN1040 1340 31JAN;OK01;HK01;;0;735;;;2PC;;0955 ;ET;0200 ;N;  
Y-012;006VIE;VIENNA SCHWECHAT;ODS;ODESA;PS;UKRAINE INTL AIRLINES;;;;;735;N
K-RUSD1470.00    ;UAH           ;;;;;;;;;;;UAH8420       ;;;   
KFTR;OUAH132      YK   ;OUAH42       UA   ;OUAH234      AT   ;OUAH16       UD   ;OUAH490      ZY   ;OUAH1512     YQ   ;OUAH80       QD   ;;;;;;;;;;;;;;;;;;;;;;;
TAX-PD 132      YK ;PD 42       UA ;PD 2332     XT ;
L-
M-CR2OS1U        ;CR2OS1U        ;CR2OS1U        ;CR2OS1U        
O-XX16JAN;XX16JAN;XX31JAN;XX31JAN
Q-ODS OS VIE OS SZG OS VIE OS ODS 000.00NUC 000.00 END ROE1.000000PD XT234AT16UD490ZY1512YQ80QD;
I-002;02GOLOVASHKIN/NINA MRS;;APODS +38(0482)393245 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
SSR DOCS OS  HK1/P/UKR/PO656253/UKR/17JUN38/F/08JUN17/GOLOVASHKINA/NINA;P2
T-K257-3231981534
FH257-2084970459;P2
FENONREF/CHNGS RESTRNONENDO/UPGRD FRM TFLYOS1U/T10
FM*M*1A
FO257-2084970459ODS16JAN13/72321244/257-20849704590E1234;P2
FPO/CASH+/CASH
FVOS
TKOK23AUG/ODSUW2100//ETOS
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX"
			);
			AssertFareSegments(
				0, "NUC",
				a => a("ODS", "OS", "VIE"),
				a => a("VIE", "OS", "SZG"),
				a => a("SZG", "OS", "VIE"),
				a => a("VIE", "OS", "ODS", 0)
			);

			ticket.Total = new Money("UAH", 1000);
			//CalculateFareSegments(100, 200, 300, 400);
			AssertFareSegmentAmounts(1470 * .10m, 1470 * .20m, 1470 * .30m, 1470 * .40m);
		}

//		[Test]
//		public void TestParseTicketFares09()
//		{
//			ParseTicket(
//@"T51G773392013960027221JAN131118 SU555AEROFLOT RUSSIAN AIRLINE17FEB13FE2C34FE2EF2
// K0X5L7R72320220 QFQQP2          K0XIRN15AG19DEC1203321JAN13026
//UAH0000000028180UAH00000000  00000000  00000000  00000000  00000000  000000000100               
//NYNYN5NNYAYH NNNX   UA                             
//000000001000002000000001000001002000003000000000
//
//A02ZAVROTSKA/TETIANAMS              021271234113204671935301000000274ADT   01  N
//
//A0403SU555AEROFLOT RUS1803N HK17FEB0600 0935 2KBPKIEV/BORYSPILSVOMOSCOW/SHEREMINL   X0   321  B 00481F TK:YJT:01.35ANL:AEROFLOT RUSSIAN AIRLINE
//A0404SU555AEROFLOT RUS 200N HK17FEB1240 0030 3SVOMOSCOW/SHEREMPEKBEIJING/BEIJIIND   O0   763  F 03606F TK:YJT:07.50ANL:AEROFLOT RUSSIAN AIRLINE
//
//A0701CNY        2200UAH        2818UAH        2818
//
//A080103NPX     0000000017FEB1317FEB13      F:NPX            E:INVOL REBOOK DUE TO FLT CXL                                 B:2PC
//A080104NPX     0000000017FEB1317FEB13      F:NPX            E:INVOL REBOOK DUE TO FLT CXL                                 B:2PC
//
//A09010BJS SU X/MOW SU IEV 173.39LPX SU X/MOW SU BJS 173.39NPX NUC34
//6.78END ROE6.34402
//
//A11CK        2818N                                     P:01
//
//A12IEVT *38 038 276 48 41-JV GURSES INTOUR-KHMELNITSKY
//A12KHMO *0673821176
//
//A14SA-PCC:K0X-NAME:JV GURSES INTOUR
//A14X*//-P1/SSRDOCSSUHK1/P/UA/EM075197/UA/01FEB89/F/03MAY17/ZAVROTSKA/TETIANA-//
//A14VL-131218JANHDQRMSUFDZPTT");

//			AssertFareSegments(
//				346.78m, "NUC",
//				a => a("BJS", "SU", "MOW"),
//				a => a("MOW", "SU", "KBP", 173.39m),
//				a => a("KBP", "SU", "MOW"),
//				a => a("MOW", "SU", "BJS", 173.39m)
//			);

//			//CalculateFareSegments(50, 50, 50, 50);
//			//AssertFareSegmentAmounts(
//			//	173.39m * 0.5m - 0.005m, 173.39m * 0.5m + 0.005m,
//			//	173.39m * 0.5m - 0.005m, 173.39m * 0.5m + 0.005m
//			//);
//		}

		[Test]
		public void TestParseTicketFares10()
		{
			ParseTicket(
@"T51G773392014420127203APR130814 PS566UKRAINE INTERNATIONAL AI08APR13E3A3FEFE2EF2
71Q471Q472322110 Q88SWA         71Q4MYNMRAG02APR1300103APR13004
UAH0000000025260UAH00000000  00000000  00000000  00000000  00000000  000000000300 KK3212 12     
NYNYN5NNYAYH NNNX   UA                             
000000001000002000000001000001002000001000000000

A02KRYCHEVSKY/ILLIAMR               093799225863329771938901000001128RP12  01  N

A0401PS566UKRAINE INTE 785L HK08APR2030 2345 2DOKDONETSK      TLVTEL AVIV YAFOINM   O0   73Q    01122F TK:YJT:03.15ANL:UKRAINE INTERNATIONAL AI
A0402PS566UKRAINE INTE 786L HK07MAY0045 0355 2TLVTEL AVIV YAFODOKDONETSK      INM   O0   320 T3 01122F TK:YJT:03.10ANL:UKRAINE INTERNATIONAL AI

A0701USD      316.00UAH        2897UAH        2526UAHT1:      42UAT2:      16UDT3:     313XT
IT:     120YK     193IL

A080101LRTILUA/0000000008APR1308APR13      F:LRTILUA/KK12   E:NON END/REF REST/RBK100USD                                  B:1PC
A080102LRTILUA/0000000007MAY1307MAY13      F:LRTILUA/KK12   E:NON END/REF REST/RBK100USD                                  B:1PC

A09010DOK PS TLV Q70.00 88.00LRTILUA/KK12 PS DOK Q70.00 88.00LRTILU
A/KK12 NUC316.00END ROE1.0 XT 120YK193IL

A11S         2897N                                     P:01

A12DOKT *ZINA
A12IEVT /38 044 206 75 70

A14VL-073502APRHDQRMPSRQKL3

A24010DOK PS TLV Q70.00 88.00LRTILUA/KK12 PS DOK Q70.00 88.00LRTILU
A/KK12 NUC316.00END ROE1.0 XT 120YK193IL

"
			);
			AssertFareSegments(
				316.00m, "NUC",
				a => a("DOK", "PS", "TLV", 88.00m, 70.00m),
				a => a("TLV", "PS", "DOK", 88.00m, 70.00m)
			);
		}


		[Test]
		public void TestParseTicketFares11()
		{
			ParseTicket(
@"T51G773392020770183107FEB131229 PS566UKRAINE INTERNATIONAL AI04MAR13FE7FBBFE2EF2
71Q371Q372320220 T2DWJK         71Q3IONIOAG05FEB1300207FEB13008
UAH0000000038860UAH00000000  00000000  00000000  00000000  00000000  000000000400 KK3212 12     
NYNYN5NNYAYH NNNX   UA                             
000000002000004000000001000001001000001000000000

A02YANOLYA/ASYAMRS                  038076017803263626230801000001748RP12  01  N
A02OVERCHUK/MYKOLAMR                038076018833263626230901000001748RP12  01  N

A0401PS566UKRAINE INTE  48L HK04MAR0705 0815 2DOKDONETSK      KBPKIEV/BORYSPILDNN   X0   737    00367F TK:YJT:01.10ANL:UKRAINE INTERNATIONAL AI
A0402PS566UKRAINE INTE 775L HK04MAR0950 1305 2KBPKIEV/BORYSPILTLVTEL AVIV YAFOINB   O0   734  F 01293F TK:YJT:03.15ANL:UKRAINE INTERNATIONAL AI
A0403PS566UKRAINE INTE 776L HK11MAR1400 1710 2TLVTEL AVIV YAFOKBPKIEV/BORYSPILIND   X0   734 T3 01293F TK:YJT:03.10ANL:UKRAINE INTERNATIONAL AI
A0404PS566UKRAINE INTE  47L HK11MAR2105 2215 2KBPKIEV/BORYSPILDOKDONETSK      DNN   O0   737  B 00367F TK:YJT:01.10ANL:UKRAINE INTERNATIONAL AI

A0701USD      243.00UAH        2417UAH        1943UAHT1:      65UAT2:      24UDT3:     385XT
IT:     192YK     193IL

A080101LRTILUA10000000004MAR1304MAR13      F:LRTILUA1/KK12  E:NON END/REF REST/RBK100USD                                  B:1PC
A080102LRTILUA10000000004MAR1304MAR13      F:LRTILUA1/KK12  E:NON END/REF REST/RBK100USD                                  B:1PC
A080103LRTILUA10000000011MAR1311MAR13      F:LRTILUA1/KK12  E:NON END/REF REST/RBK100USD                                  B:1PC
A080104LRTILUA10000000011MAR1311MAR13      F:LRTILUA1/KK12  E:NON END/REF REST/RBK100USD                                  B:1PC

A09010DOK PS X/IEV PS TLV Q70.00 51.48LRTILUA1/KK12 PS X/IEV Q70.00
 PS DOK 51.48LRTILUA1/KK12 NUC242.96END ROE1.0 XT 192YK193IL

A11S         4834N                                     

A12UFSA  PALC

A14VL-101105FEBHDQRMPSRM4K0

A24010DOK PS X/IEV PS TLV Q70.00 51.48LRTILUA1/KK12 PS X/IEV Q70.00
 PS DOK 51.48LRTILUA1/KK12 NUC242.96END ROE1.0 XT 192YK193IL

"
			);
			AssertFareSegments(
				242.96m, "NUC",
				a => a("DOK", "PS", "KBP"),
				a => a("KBP", "PS", "TLV", 51.48m, 70.00m),
				a => a("TLV", "PS", "KBP", null, 70.00m),
				a => a("KBP", "PS", "DOK", 51.48m)
			);
		}

		[Test]
		public void TestParseTicketFares12()
		{
			ParseTicket(
@"T51G773392014690077607FEB131048 UT298UTAIR AVIATION          13FEB13FE854AFE2EF2
30FU5T7972321255 LT5T50         30FUOPYDPAG07FEB1300007FEB13007
UAH0000000017510UAH00000000  00000000  00000000  00000000  00000000  000000000100               
NNNYN5NNYAYH NNNX   UA                             
000000001000002000000001000001002000002000000000

A02SCHERBAKOV/VLADISLAVMR           038020592353263633193201000000688ADT   01  N
SI:GEN:SCHERBAKOV/VLADISLAVMR                                 TL:07FEB13

A0401UT298UTAIR AVAITI 702H HK13FEB1255 1625 2HRKKHARKIV      VKOMOSCOW/VNUKOVIN    O0   CRJ    00404F TK:YJT:01.30ANL:UTAIR AVAITION          
A0402UT298UTAIR AVAITI 569K HK13FEB2220 0530 3VKOMOSCOW/VNUKOVOVBNOVOSIBIRSK  DN    O0   738  A 01754F TK:YJT:04.10ANL:UTAIR AVAITION          

A0701USD      219.00UAH        2287UAH        1751UAHT1:      44UAT2:      16UDT3:     476XT
IT:     112YK     364YQ

A080101HSS2M   00000000       13APR13      F:HSS2M          B:20K
A080102KSALERT 00000000       13APR13      F:KSALERT        B:20K

A09010HRK UT MOW 117.50UT OVB 101.95 NUC219.45END ROE1.0 XT 112YK36
4YQ

A11S         2287N                                     P:01

A12IEVT *38 057 7666089-UNIVERSAL FLIGHTS-KHARKOV
A12HRKT *0931399712

A14SA-PCC:30FU-NAME:UNIVERSAL FLIGHTS HRK 30FU
A14VL-100807FEBTJMRMUT48N4X1

A200001SSRFOIDHK
FT:/PP5011933978

A24010HRK UT MOW 117.50UT OVB 101.95 NUC219.45END ROE1.0 XT 112YK36
4YQ

A27N 01               UAH        2287"
			);
			AssertFareSegments(
				219.45m, "NUC",
				a => a("HRK", "UT", "VKO", 117.50m),
				a => a("VKO", "UT", "OVB", 101.95m)
			);
		}

		[Test]
		public void TestParseTicketFares13()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;1500055562;1A1326991;001001
AMD 1503372051;1/1;              
GW3712703;1A1326991;IEV1A0985;AIR
MUC1A X6G28Q055;0202;HRKUW2100;72321255;HRKUW2100;72321255;HRKUW2100;72321255;HRKUW2100;72321255;;;;;;;;;;;;;;;;;;;;;;OS X6G28Q
A-AUSTRIAN AIRLINES;OS 2575
B-TTP
C-7906/ 1981BKSU-1981BKSU-F-N--
D-130313;130315;130315
G-X  ;;HRKHRK;E1
H-019;003OHRK;KHARKIV OSNOVA IN;VIE;VIENNA SCHWECHAT ;OS    0752 T T 05MAY1450 1625 05MAY;OK02;HK02;S ;0;F70;;TYROLEAN AIRWAYS;1PC;;1350 ;ET;0235 ;N;902;UA;AT;  
Y-019;003HRK;KHARKIV OSNOVA IN;VIE;VIENNA SCHWECHAT;VO;TYROLEAN AIRWAYS;;;;;F70;N
H-020;004XVIE;VIENNA SCHWECHAT ;MUC;MUNICH           ;OS    0115 T T 05MAY1650 1750 05MAY;OK02;HK02;S ;0;100;;TYROLEAN AIRWAYS;1PC;;1605 ;ET;0100 ;N;220;AT;DE;2 
Y-020;004VIE;VIENNA SCHWECHAT;MUC;MUNICH;VO;TYROLEAN AIRWAYS;;;;;100;N
H-018;005OMUC;MUNICH           ;VIE;VIENNA SCHWECHAT ;OS    0116 T T 07MAY1840 1945 07MAY;OK02;HK02;S ;0;100;;TYROLEAN AIRWAYS;1PC;2 ;1800 ;ET;0105 ;N;220;DE;AT;  
Y-018;005MUC;MUNICH;VIE;VIENNA SCHWECHAT;VO;TYROLEAN AIRWAYS;;;;;100;N
H-012;006OVIE;VIENNA SCHWECHAT ;HRK;KHARKIV OSNOVA IN;OS    0751 T T 12MAY1025 1350 12MAY;OK02;HK02;S ;0;F70;;TYROLEAN AIRWAYS;1PC;;0940 ;ET;0225 ;N;902;AT;UA;  
Y-012;006VIE;VIENNA SCHWECHAT;HRK;KHARKIV OSNOVA IN;VO;TYROLEAN AIRWAYS;;;;;F70;N
K-
KN-IUSD387.00     ;UAH3094       ;;;;;;;;;;;UAH5772       ;7.9930     ;;   
KNTI; UAH112      YK AE; UAH16       UD DP; UAH1572     YQ AC; UAH44       UA SE; UAH374      ZY AE; UAH73       QD AP; UAH160      AT SE; UAH78       OY CB; UAH194      RA EB; UAH55       DE SE;;;;;;;;;;;;;;;;;;;;
KS-IUSD387.00     ;UAH3094       ;;;;;;;;;;;UAH5772       ;7.9930     ;;   
KSTI; UAH112      YK AE; UAH16       UD DP; UAH1572     YQ AC; UAH44       UA SE; UAH374      ZY AE; UAH73       QD AP; UAH160      AT SE; UAH78       OY CB; UAH194      RA EB; UAH55       DE SE;;;;;;;;;;;;;;;;;;;;
TAX-UAH112      YK ;UAH16       UD ;UAH2550     XT ;
SIAI;;IT     
L-
M-TAXTO1UA       ;TAXTO1UA       ;TAXTO1UA       ;TAXTO1UA       
N-;;;;;
O-XX05AUG;XX05AUG;07MAY05AUG;07MAY05AUG
Q-HRK OS X/VIE OS MUC M/IT OS VIE OS HRK M/IT 1S50.00END XT1572YQ44UA374ZY73QD160AT78OY194RA55DE;FXB/R,UP
I-001;01TURYNSKA/OLEKSANDRA MRS;;APHRK +38057-7194990 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
FQV OS  FQTV-OS992001442645873;S3;P1
FQV OS  FQTV-OS992001442645873;S4;P1
FQV OS  FQTV-OS992001442645873;S5;P1
FQV OS  FQTV-OS992001442645873;S6;P1
SSR DOCS OS  HK1/P/UKR/EK451204/UKR/01APR94/F/16NOV21/TURYNSKA/OLEKSANDRA;S3;P1
SSR DOCS OS  HK1/P/UKR/EK451204/UKR/01APR94/F/16NOV21/TURYNSKA/OLEKSANDRA;S4;P1
SSR DOCS OS  HK1/P/UKR/EK451204/UKR/01APR94/F/16NOV21/TURYNSKA/OLEKSANDRA;S5;P1
SSR DOCS OS  HK1/P/UKR/EK451204/UKR/01APR94/F/16NOV21/TURYNSKA/OLEKSANDRA;S6;P1
OSI OS  DS/EXP/UA167771
T-K257-3232290096
FEREF/RBKG RESTR/NONENDO;S3-6;P1-2
FM*F*0.00;S3-6;P1-2
FPCASH;S3-6;P1-2
FTUA0012
FV*F*OS;S3-6;P1-2
TKTL16MAR/HRKUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
I-002;02TURYNSKA/TETIANA MRS;;APHRK +38057-7194990 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
FQV OS  FQTV-OS992001409674494;S3;P2
FQV OS  FQTV-OS992001409674494;S4;P2
FQV OS  FQTV-OS992001409674494;S5;P2
FQV OS  FQTV-OS992001409674494;S6;P2
SSR DOCS OS  HK1/P/UKR/EH998385/UKR/24JUN88/F/10JUN21/TURYNSKA/TETIANA;S3;P2
SSR DOCS OS  HK1/P/UKR/EH998385/UKR/24JUN88/F/10JUN21/TURYNSKA/TETIANA;S4;P2
SSR DOCS OS  HK1/P/UKR/EH998385/UKR/24JUN88/F/10JUN21/TURYNSKA/TETIANA;S5;P2
SSR DOCS OS  HK1/P/UKR/EH998385/UKR/24JUN88/F/10JUN21/TURYNSKA/TETIANA;S6;P2
OSI OS  DS/EXP/UA167771
T-K257-3232290097
FEREF/RBKG RESTR/NONENDO;S3-6;P1-2
FM*F*0.00;S3-6;P1-2
FPCASH;S3-6;P1-2
FTUA0012
FV*F*OS;S3-6;P1-2
TKTL16MAR/HRKUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
RIR7100
ENDX
"
			);
			AssertFareSegments(
				0, "",
				a => a("HRK", "OS", "VIE"),
				a => a("VIE", "OS", "MUC", isInclusive: true),
				a => a("MUC", "OS", "VIE"),
				a => a("VIE", "OS", "HRK", stopoverOrTransferCharge: 50m, isInclusive: true)
			);
		}

		//[Test]
		//public void TestParseTicketFares14()
		//{
		//			ParseTicket(
		//@
		//			);
		//	AssertFareSegments(
		//		"IEV TK X/IST TK KRT M542.50TK X/IST TK IEV M542.50NUC1085.00END ROE1.000000PD XT14.00UD28.00UA;FXP/R,UP,27NOV08/S2-5",
		//		1085.00m, "NUC",
		//		a => a("KBP", "TK", "IST"),
		//		a => a("IST", "TK", "KRT", 542.50m),
		//		a => a("KRT", "TK", "IST"),
		//		a => a("IST", "TK", "KBP", 542.50m)
		//	);
		//}


		//[Test]
		//public void TestParseTicketFares15()
		//{
		//			ParseTicket(
		//@
		//			);
		//	AssertFareSegments(
		//		"IEV FZ X/DXB EK BJS Q63.76Q9.10 221.22EK X/DXB FZ IEV Q63.76Q9.10 221.22 NUC588.16END ROE0.768453 XT 136YK116CN",
		//		588.16m, "NUC",
		//		a => a("KBP", "FZ", "DXB"),
		//		a => a("DXB", "EK", "BJS", 221.22m, 63.76m + 9.10m),
		//		a => a("BJS", "EK", "DXB"),
		//		a => a("DXB", "FZ", "KBP", 221.22m, 63.76m + 9.10m)
		//	);
		//}

		//[Test]
		//public void TestParseTicketFares17()
		//{
		//			ParseTicket(
		//@
		//			);
		//	AssertFareSegments(
		//		"DOK SU MOW120.00NUC120.00END ROE1.000000XT39YR42UA;FXB/R,UP",
		//		120.00m, "NUC",
		//		a => a("DOK", "SU", "MOW", 120.00m)
		//	);
		//}

		[Test]
		public void TestParseTicketFares18()
		{
			ParseTicket(
@"T51G773392015220119807MAR130937 PS566UKRAINE INTERNATIONAL AI15APR13E3A3FDFE2EF2
71Q471Q472322110 ZZ90GI         71Q4MYNMYAG07MAR1300007MAR13007
UAH0000000050520UAH00000000  00000000  00000000  00000000  00000000  000000000400 KK3212 12     
NYNYN5NNYAYH NNNX   UA                             
000000002000002000000001000001002000001000000000
		
A02ORDELOVA/IYAMRS                  066842979803329771930401000001058RP12  01  N
A02ORDELOV/STANYSLAVMR              066842980833329771930501000001058RP12  01  N
		
A0401PS566UKRAINE INTE 785L HK15APR2120 0035 3DOKDONETSK      TLVTEL AVIV YAFOINM   O0   737    01122F TK:YJT:03.15ANL:UKRAINE INTERNATIONAL AI
A0402PS566UKRAINE INTE 786L HK23APR0135 0445 2TLVTEL AVIV YAFODOKDONETSK      INM   O0   737    01122F TK:YJT:03.10ANL:UKRAINE INTERNATIONAL AI
		
A0701USD      316.00UAH        2897UAH        2526UAHT1:      42UAT2:      16UDT3:     313XT
IT:     120YK     193IL
		
A080101LRTILUA/0000000015APR1315APR13      F:LRTILUA/KK12   E:NON END/REF REST/RBK100USD                                  B:1PC
A080102LRTILUA/0000000023APR1323APR13      F:LRTILUA/KK12   E:NON END/REF REST/RBK100USD                                  B:1PC
		
A09010DOK PS TLV Q70.00 88.00LRTILUA/KK12 PS DOK Q70.00 88.00LRTILU
A/KK12 NUC316.00END ROE1.0 XT 120YK193IL
		
A11S         5794N                                     
		
A12DOKT *YUSIMOV
A12IEVT /38 044 206 75 70
		
A14VL-070907MARHDQRMPSRMCTW
		
A24010DOK PS TLV Q70.0088.00LRTILUA/KK12 PS DOK Q70.00 88.00LRTILU
A/KK12 NUC316.00END ROE1.0 XT 120YK193IL"
			);

			AssertFareSegments(
				316.00m, "NUC",
				a => a("DOK", "PS", "TLV", 88m, 70m),
				a => a("TLV", "PS", "DOK", 88m, 70m)
			);
		}

		[Test]
		public void TestParseTicketFares19()
		{
			ParseTicket(
@"T51G773392030860101504MAY131124 DL006DELTA AIR LINES INC.    08MAY13FE854AFE2EF2
30FU5T7972321255 RZDC26         30FUOPYDPAG03MAY1300104MAY13012
UAH0000000078970UAH00000000  00000000  00000000  00000000  00000000  000000000100               
NNNYN5NYYAYH NNNX   UA                             
000000001000006000000001000001002000003000000000

A02GOLOLOBOV/SERGIIMR               124430462313329771148102000000898ADT   01  N
TL:06MAY13

A0401DL006DELTA AIR LI9467T HK08MAY1400 1600 2KBPKIEV/BORYSPILAMSAMSTERDAM/SCHIND   X0   737  D 01111F AC:KLM ROYAL DUTK:YJT:03.00ANL:DELTA AIR LINES INC.    ACL:KLM ROYAL DUTCH AIRL    
A0402DL006DELTA AIR LI 265T HK08MAY1650 1850 2AMSAMSTERDAM/SCHMSPMINNEAPOLIS  IND   X0   333    04159F TK:YJT:09.00ANL:DELTA AIR LINES INC.    
A0403DL006DELTA AIR LI4645T HK08MAY2150 2302 2MSPMINNEAPOLIS  GFKGRAND FORKS  DN    O0   CRJ T1 00284F AC:SKYWEST DBA TK:YJT:01.12ANL:DELTA AIR LINES INC.    ACL:SKYWEST DBA DELTA CONNEC
A0404DL006DELTA AIR LI4751T HK01DEC1720 1830 2GFKGRAND FORKS  MSPMINNEAPOLIS  DN    X0   CRJ    00284F AC:SKYWEST DBA TK:YJT:01.10ANL:DELTA AIR LINES INC.    ACL:SKYWEST DBA DELTA CONNEC
A0405DL006DELTA AIR LI 264T HK01DEC1925 1050 3MSPMINNEAPOLIS  AMSAMSTERDAM/SCHIND   X0   333 T1 04159F TK:YJT:08.25ANL:DELTA AIR LINES INC.    
A0406PS566UKRAINE INTE 102N HK02DEC1310 1655 2AMSAMSTERDAM/SCHKBPKIEV/BORYSPILINS   O0   73N T2 01111F TK:YJT:02.45ANL:UKRAINE INTERNATIONAL AI

A0701USD      988.00UAH       11865UAH        7897UAHT1:      32UAT2:      16UDT3:    3920XT
IT:     136YK     152CJ     142RN      42VV      60AY     276US      40XA      36XF      56XY      44YC    2528YR     408YQ

A080101TLPXUA5 0000000008MAY1308MAY13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC
A080102TLPXUA5 0000000008MAY1308MAY13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC
A080103TLPXUA5 0000000008MAY1308MAY13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC
A080104TLPXUA5 0000000001DEC1301DEC13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC
A080105TLPXUA5 0000000001DEC1301DEC13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC
A080106TLPXUA5 0000000002DEC1302DEC13      F:TLPXUA5        E:REF PENALTY/PEX                                             B:1PC

A09010IEV DL X/AMS DL X/MSP DL GFK M494.00DL X/MSP DL X/AMS PS IEV
M494.00 NUC988.00END ROE1.0 XT 136YK152CJ142RN42VV60AY276US40
XA56XY44YC2528YR408YQ36XF MSP4.5

A11S        11865N                                     P:01

A12IEVT *38 057 7666089-UNIVERSAL FLIGHTS-KHARKOV
A12HRKT *0990339749

A14SA-PCC:30FU-NAME:UNIVERSAL FLIGHTS HRK 30FU
A14VL-121103MAYHDQRMPSRF7SJ
A14VL-121103MAYHDQRMDLF7TE5T

A200001SSRFOIDHK
FT:/PPEM026398
A200001SSRFOIDHK
FT:/PPEM026398

A24010IEV DL X/AMS DL X/MSP DL GFK M494.00DL X/MSP DL X/AMS PS IEV
M494.00 NUC988.00END ROE1.0 XT 136YK152CJ142RN42VV60AY276US40
XA56XY44YC2528YR408YQ36XF MSP4.5

A27N 01               UAH       11865

"
			);
			AssertFareSegments(
				988.00m, "NUC",
				a => a("KBP", "DL", "AMS"),
				a => a("AMS", "DL", "MSP"),
				a => a("MSP", "DL", "GFK", 494.00m),
				a => a("GFK", "DL", "MSP"),
				a => a("MSP", "DL", "AMS"),
				a => a("AMS", "PS", "KBP", 494.00m)
			);
		}

		[Test]
		public void TestParseTicketFares20()
		{
			ParseTicket(
@"T51G773392017050071704JAN131711 BA125BRITISH AIRWAYS         05JAN13FE854AFE2EF2
3Y665T7972321255 MJVF1K         3Y66KTYDPAG04JAN1300004JAN13020
UAH0000000594780UAH00000000  00000000  00000000  00000000  00000000  000000000100               
NNNYN5NNYAYH NNNX   UA                             
000000002000002000000001000001001000002000000000

A02BOLGOV/OLEKSANDRMR               004115758343263633186101000000637ADT   01  N
SI:GEN:BOLGOV/OLEKSANDRMR                                     TL:05JAN13
A02BOLGOVA/GANNAMRS                 004115759303263633186201000000637ADT   01  N
SI:GEN:BOLGOVA/GANNAMRS                                       TL:05JAN13

A0401BA125BRITISH AIRW2203I HK05JAN1120 1620 2LGWLONDON/GATWICCUNCANCUN       INM   O0   777  N 04963F TK:YJT:11.00ANL:BRITISH AIRWAYS         
A0402BA125BRITISH AIRW2202D HK14JAN1625 0730 3CUNCANCUN       LGWLONDON/GATWICINM   O0   777 T2 04963F TK:YJT:09.05ANL:BRITISH AIRWAYS         

A0701GBP     2290.00UAH       37060UAH       29739UAHT1:    2104GBT2:     146UBT3:    5071XT
IT:     184UK     225XD    4662YQ

A080101I2UKJB  0000000005JAN1305JAN13      F:I2UKJB         B:3PC
A080102D2UKJB  0000000014JAN1314JAN13      F:D2UKJB         B:3PC

A09010LON BA CUN 1447.43BA LON 2235.47 NUC3682.90END ROE0.621791I/2
03LCM                           0101 XT 184UK225XD4662YQ

A11S        74120N                                     

A12IEVT *380577142333-ELIT TOURISM LTD-KHARKIV

A14SA-PCC:3Y66-NAME:ELIT TOURISM LTD
A14VL-083304JANMUCRM1AX28CVZ

A24010LON BA CUN 1447.43BA LON 2235.47 NUC3682.90END ROE0.621791I/2
03LCM                           0101 XT 184UK225XD4662YQ

A27N 01               UAH       37060
A27N 01               UAH       37060

"
			);
			AssertFareSegments(
				3682.90m, "NUC",
				a => a("LGW", "BA", "CUN", 1447.43m),
				a => a("CUN", "BA", "LGW", 2235.47m)
			);

			//CalculateFareSegments(25, 75);
			AssertFareSegmentAmounts(1447.43m, 2235.47m);
		}

		[Test]
		public void TestParseTicketFares21()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;0700078871;1A1326991;001001
AMD 0703265421;1/1;              
GW3672598;1A1326991;IEV1A0985;AIR
MUC1A 66E6J7093;0101;IEVUW2103;72322666;IEVUW2103;72322666;IEVUW2103;72322666;IEVUW2103;72322666;;;;;;;;;;;;;;;;;;;;;;OS 66E6J7
A-AUSTRIAN AIRLINES;OS 2575
B-TTP/RT
C-7906/ 1705GLSU-1705GLSU-I-0--
D-130204;130207;130207
G-X  ;;PARIEV;E1
H-031;002OCDG;PARIS CDG        ;VIE;VIENNA SCHWECHAT ;OS    7116 Y Y 17MAR1240 1440 17MAR;OK01;HK01;;0;321;;;1PC;2F;1155 ;ET;0200 ;N;643;FR;AT;  
X-031;002OCDG;PARIS CDG        ;VIE;VIENNA SCHWECHAT ;AF    1738 Y Y 17MAR1240 1440 17MAR;OK01;HK01;;0;321;;;1PC;2F;1155 ;ET;0200 ;N;  
Y-031;002CDG;PARIS CDG;VIE;VIENNA SCHWECHAT;AF;AIR FRANCE;;;;;321;N
H-032;003OVIE;VIENNA SCHWECHAT ;INN;INNSBRUCK        ;OS    0901 E E 17MAR1715 1815 17MAR;OK01;HK01;R ;0;738;;TYROLEAN AIRWAYS;1PC;;1630 ;ET;0100 ;N;249;AT;AT;  
Y-032;003VIE;VIENNA SCHWECHAT;INN;INNSBRUCK;VO;TYROLEAN AIRWAYS;;;;;738;N
H-035;004OINN;INNSBRUCK        ;VIE;VIENNA SCHWECHAT ;OS    0916 L L 23MAR0815 0920 23MAR;OK01;HK01;R ;0;320;;TYROLEAN AIRWAYS;1PC;;0730 ;ET;0105 ;N;249;AT;AT;  
Y-035;004INN;INNSBRUCK;VIE;VIENNA SCHWECHAT;VO;TYROLEAN AIRWAYS;;;;;320;N
H-037;005OVIE;VIENNA SCHWECHAT ;KBP;KIEV BORYSPIL    ;OS    0661 Y Y 23MAR0945 1240 23MAR;OK01;HK01;S ;0;100;;TYROLEAN AIRWAYS;1PC;;0900 ;ET;0155 ;N;667;AT;UA;D 
Y-037;005VIE;VIENNA SCHWECHAT;KBP;KIEV BORYSPIL;VO;TYROLEAN AIRWAYS;;;;;100;N
K-FEUR653.00     ;UAH7055       ;;;;;;;;;;;UAH9808       ;10.80413   ;;   
KFTF; UAH1493     YQ AC; UAH143      QX AP; UAH11       IZ EB; UAH46       FR SE; UAH138      FR TI; UAH548      ZY AE; UAH76       QD AP; UAH298      AT SE;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH1493     YQ ;UAH143      QX ;UAH1117     XT ;
L-
M-YR3OS9F        ;EBUY2POS       ;LBUY2POS       ;YR3OS9F        
N-NUC
O-XXXX;17MAR17MAR;23MAR23MAR;XXXX
Q-PAR OS VIE(OS INN90.44OS VIE60.51)OS IEV698.80NUC849.75END ROE0.768453XT11IZ46FR138FR548ZY76QD298AT;FXB
I-001;01PUPKO/LEV MR;;APIEV NA - UNIVERSAL FLIGHTS SALES AGENCY - A//IEV NA - UNIVERSAL FLIGHTS SALES AGENCY - A//IEV NA - UNIVERSAL FLIGHTS SALES AGENCY - A;;
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 06MAR13 1140GMT OR SEG WILL BE CANX
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 06MAR13 1140GMT OR SEG WILL BE CANX
SSR OTHS 1A  /PLS ADV TKT NBRS OF OS SEG LATEST 13MAR13 1140GMT OR SEG WILL BE CANX
SSR DOCS OS  HK1/P/UKR/EK499628/UKR/16OCT54/M/18SEP19/PUPKO/LEV MR;P1
T-K257-3232044357
FENONREF/CHNG RESTR/NONENDO;S2-5;P1
FM*M*1A
FPCASH
FVOS;S2-5;P1
TKTL07FEB/1700/IEVUW2103
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX
"
			);
			AssertFareSegments(
				849.75m, "NUC",
				a => a("CDG", "OS", "VIE"),
				a => a("VIE", "OS", "INN", 90.44m),
				a => a("INN", "OS", "VIE", 60.51m),
				a => a("VIE", "OS", "KBP", 698.80m)
			);

			//CalculateFareSegments(50, 33, 44, 50);
			AssertFareSegmentAmounts(698.80m * .5m, 90.44m, 60.51m, 698.80m * .5m);
		}

		[Test]
		public void TestParseTicketFares22()
		{
			ParseTicket(
@"AIR-BLK207;7A;;257;1100030574;1A1326991;001001
AMD 1103468560;1/1;              
GW3670691;1A1326991;IEV1A0985;AIR
MUC1A 6KSV6Y031;0202;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;CM AXBWKJ;KL 6KSV6Y
A-KLM ROYAL DUTCH AIRLINES;KL 0744
B-TTP/ET/RT
C-7906/ 2106TDSU-1108NSSU-I-0--
D-130410;130411;130411
G-X  ;;IEVIEV;
H-004;003OKBP;KIEV BORYSPIL    ;AMS;AMSTERDAM        ;KL    3097 J J 26APR0940 1135 26APR;OK02;HK02;M ;0;734;;;2PC;F ;;ET;0255 ; ;1129;UA;NL;  
X-004;003OKBP;KIEV BORYSPIL    ;AMS;AMSTERDAM        ;PS    0101 C J 26APR0940 1135 26APR;OK02;HK02;M ;0;734;;;2PC;F ;;ET;0255 ; ;  
Y-004;003KBP;KIEV BORYSPIL;AMS;AMSTERDAM;PS;UKRAINE INTL AIRLINES;;;;;734;N
H-012;004XAMS;AMSTERDAM        ;PTY;PANAMA CITY PTY  ;KL    0757 I I 26APR1305 1650 26APR;OK02;HK02;M ;0;77W;M;;2PC;;;ET;1045 ; ;5497;NL;PA;  
H-016;005OPTY;PANAMA CITY PTY  ;MGA;MANAGUA          ;CM    0711 S S 26APR1858 1938 26APR;OK02;HK02;S ;0;E90;;;2PC;;;ET;0140 ; ;502;PA;NI;  
H-017;006OMGA;MANAGUA          ;PTY;PANAMA CITY PTY  ;CM    0710 S S 04MAY0753 1028 04MAY;OK02;HK02;S ;0;E90;;;;;;ET;0135 ; ;502;NI;PA;  
H-011;007OPTY;PANAMA CITY PTY  ;HAV;HAVANA           ;CM    0246 D D 04MAY1214 1549 04MAY;OK02;HK02;M ;0;738;;;2PC;;;ET;0235 ; ;984;PA;CU;  
H-015;008OHAV;HAVANA           ;AMS;AMSTERDAM        ;KL    0724 D D 09MAY1645 0830 10MAY;OK02;HK02;M ;0;332;M;;2PC;3 ;;ET;0945 ; ;4869;CU;NL;  
H-009;009OAMS;AMSTERDAM        ;KBP;KIEV BORYSPIL    ;KL    1387 J J 11MAY2035 0020 12MAY;OK02;HK02;M ;0;73H;;;2PC;;;ET;0245 ; ;1129;NL;UA;D 
K-FUSD4860.00    ;UAH38846      ;;;;;;;;;;;UAH45104      ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH5172     YR VB; UAH32       UA SE; UAH231      RN DP; UAH42       VV MU; UAH209      CJ SO; UAH20       AH SE; UAH312      FC TO; UAH24       FD TR; UAH40       PI VA; UAH24       PX VD;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH6106     XT ;
L-
M-I2FFUA         ;I2FFUA         ;S07Q65         ;S07Q65         ;I2FFUA         ;DFFUA          ;DFFUA          
N-NUC;;227.50;227.50;1938.50;;2466.50
O-XXXX;XXXX;26APR26APR;04MAY04MAY;XXXX;XXXX;XXXX
Q-IEV KL X/AMS KL PTY(CM MGA Q70.00 157.50CM PTY Q70.00 157.50)CM HAV1938.50KL AMS KL IEV2466.50NUC4860.00END ROE1.000000XT5172YR32UA231RN42VV209CJ20AH312FC24FD40PI24PX;FXA
I-001;01MORDOVINA/VIRA MRS;;APIEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A//E VIRA_74@BK.RU;0ZQJR0;
FQV KL  FQTV0-KL2073750172;P1
SSR ADTK 1A  /TO KL BY 19APR/1100Z OTHERWISE WILL BE XXLD
SSR ADTK 1A  /KK2 . PLS SEND TKT NUMBER IN OSI/SSR 1500/23APR
SSR ADTK 1A  /KK2 . FVR ENVIAR TKT NUMBER EN OSI/SSR 1500/23APR
SSR DOCS KL  HK1/P/UKR/EC693427/UKR/20AUG74/F/17AUG16/MORDOVINA/VIRA/H;P1
SSR DOCS CM  HK1/P/UKR/EC693427/UKR/20AUG74/F/17AUG16/MORDOVINA/VIRA/H;P1
T-K074-3532502290-91
FENON-END/BEFORE DPTR REF AFTER DPTR NONREF PNLTY FOR CHNGS APPLY;S3-9;P1-2
FM*M*1A
FPCASH
FVKL;S3-9;P1-2
TKTL12APR/IEVUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
I-002;02TITLIANOV/IEVGENII MR;;APIEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A//E VIRA_74@BK.RU;;
FQV KL  FQTV-KL1375934986;P2
SSR ADTK 1A  /TO KL BY 19APR/1100Z OTHERWISE WILL BE XXLD
SSR ADTK 1A  /KK2 . PLS SEND TKT NUMBER IN OSI/SSR 1500/23APR
SSR ADTK 1A  /KK2 . FVR ENVIAR TKT NUMBER EN OSI/SSR 1500/23APR
SSR DOCS KL  HK1/P/UKR/EE729024/UKR/28MAY59/M/24NOV18/TITLIANOV/IEVGENII;P2
SSR DOCS CM  HK1/P/UKR/EE729024/UKR/28MAY59/M/24NOV18/TITLIANOV/IEVGENII;P2
T-K074-3532502292-93
FENON-END/BEFORE DPTR REF AFTER DPTR NONREF PNLTY FOR CHNGS APPLY;S3-9;P1-2
FM*M*1A
FPCASH
FVKL;S3-9;P1-2
TKTL12APR/IEVUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
RII47004 UAH ONE PERSON
ENDX"
			);
			AssertFareSegments(
				4860.00m, "NUC",
				a => a("KBP", "KL", "AMS"),
				a => a("AMS", "KL", "PTY"),
				a => a("PTY", "CM", "MGA", 157.50m, 70.00m),
				a => a("MGA", "CM", "PTY", 157.50m, 70.00m),
				a => a("PTY", "CM", "HAV", 1938.50m),
				a => a("HAV", "KL", "AMS"),
				a => a("AMS", "KL", "KBP", 2466.50m)
			);

			//CalculateFareSegments(25, 25, 33, 44, 50, 25, 75);
			AssertFareSegmentAmounts(
				1938.50m * .25m - .005m,
				1938.50m * .25m + .005m,
				157.50m + 70.00m,
				157.50m + 70.00m,
				1938.50m * .5m,
				2466.50m * .25m - .005m,
				2466.50m * .75m + .005m
			);
		}

		[Test]
		public void TestParseTicketFares23()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;2200010032;1A1326991;001001
AMD 2203210969;1/1;              
GW3670593;1A1326991;IEV1A0985;AIR
MUC1A X8G548010;0101;DOKUW2100;72322110;DOKUW2100;72322110;DOKUW2100;72322110;DOKUW2100;72322110;;;;;;;;;;;;;;;;;;;;;;LY X8G548
A-EL AL ISRAEL AIRLINES;LY 1142
B-TTP
C-7906/ 0009DUSU-0009DUSU-I-0--
D-130121;130122;130122
G-X  ;;IEVETH;
H-003;002OKBP;KIEV BORYSPIL    ;TLV;TEL AVIV B GURION;LY    0652 L L 17FEB2255 0215 18FEB;OK01;HK01;S ;0;738;M;;1PC;B ;;ET;0320 ;N;1284;UA;IL;3 
H-010;003XTLV;TEL AVIV B GURION;ETH;EILAT            ;LY    0401 G G 18FEB0715 0820 18FEB;OK01;HK01;R ;0;738;M;;1PC;1 ;;ET;0105 ;N;168;IL;IL;  
K-FUSD207.00     ;UAH1655       ;;;;;;;;;;;UAH1903       ;7.9930     ;;   
KFTF; UAH136      YK AE; UAH16       UD DP; UAH32       UA SE; UAH64       AP SE;;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH136      YK ;UAH16       UD ;UAH96       XT ;
L-
M-LUAOW    ZZ    ;LUAOW    ZZ    
N-NUC;84.75
O-17FEB17FEB;18FEB18FEB
Q-IEV LY X/TLV Q122.00LY ETH M84.75NUC206.75END ROE1.000000XT32UA64AP;FXB
I-001;01LAVRENOVA/GANNA(YTH);;APZINA;;
SSR OTHS 1A  /ADTK TO LY BY 24JAN2013/2000 OR SPACE WILL BE CXLD AUTOMATICALLY
SSR DOCS LY  HK1/P/UKR/EE392038/UKR/22JUL88/F/12AUG18/LAVRENOVA/GANNA;P1
T-K114-3232012779
FEFARE RESTRICTIONS APPLY;S2-3;P1
FM*M*4
FPCASH
FVLY;S2-3;P1
TKTL23JAN/DOKUW2100
RII2203.00
ENDX
"
			);
			AssertFareSegments(
				206.75m, "NUC",
				a => a("KBP", "LY", "TLV", null, 122.00m),
				a => a("TLV", "LY", "ETH", 84.75m)
			);

			//CalculateFareSegments(50, 50);
			AssertFareSegmentAmounts(
				84.75m * .5m + 122.00m - .005m,
				84.75m * .5m + .005m
			);
		}

		[Test]
		public void TestParseTicketFares24()
		{
			ParseTicket(
@"T51G773392021360057701MAR131348 PS566UKRAINE INTERNATIONAL AI10MAR13FE684FFE2EF2
39XO39XO72321270 M5M0WY         39XOSRNSRAG01MAR1300001MAR13013
UAH0000000029180UAH00000000  00000000  00000000  00000000  00000000  000000000300 SF078213      
NNNYN5NNYAYA NNNX   UA                             
000000001000004000002001000001001000002000000000

A02POPOV/KOSTYANTYNMR                          3263626759301         ADT   01  N
TL:10MAR13

A0401PS566UKRAINE INTE 571Q HK10MAR0620 0945 2KBPKIEV/BORYSPILDMEMOSCOW/DOMODEINS   X0   735  F 00467F TK:YJT:01.25ANL:UKRAINE INTERNATIONAL AI
A0402S7421SIBERIA AIRL 303S HK10MAR1510 1915 2DMEMOSCOW/DOMODEPEEPERM         DNM   O0   319    00725F TK:YJT:02.05ANL:SIBERIA AIRLINES        
A0403S7421SIBERIA AIRL 304S HK24MAR1955 2010 2PEEPERM         DMEMOSCOW/DOMODEDNM   X0   319    00725F TK:YJT:02.15ANL:SIBERIA AIRLINES        
A0404PS566UKRAINE INTE 574N HK24MAR2310 2235 2DMEMOSCOW/DOMODEKBPKIEV/BORYSPILINS   O0   737    00467F TK:YJT:01.25ANL:UKRAINE INTERNATIONAL AI

A0701USD      365.00UAH        3320UAH        2918UAHT1:      32UAT2:      16UDT3:     354XT
IT:     136YK     218YQ

A080101QS2MUA  0000000010MAR1310MAR13      F:QS2MUA         E:NON END/REF AND CHNG RESTR   E:PS/S7 SPA                    B:1PC
A080102QS2MUA  0000000010MAR1310MAR13      F:QS2MUA         E:NON END/REF AND CHNG RESTR   E:PS/S7 SPA                    B:1PC
A080103NS1MUA  0000000024MAR1324MAR13      F:N1MUA         E:NON END/REF AND CHNG RESTR   E:PS/S7 SPA                    B:1PC
A080104NS1MUA  0000000024MAR1324MAR13      F:NS1MUA         E:NON END/REF AND CHNG RESTR   E:PS/S7 SPA                    B:1PC

A09010IEV PS X/MOW S7 PEE 195.00S7X/MOW PS IEV 170.00 NUC365.00END
ROE1.0 XT 136YK218YQ

A11S         3320N                                     P:01

A12IEVT *38056 404 23 23-UNIVERSAL FLIGHTS SALES AGENCY-

A14VL-134001MARHDQRMS7VBW03
A14VL-134301MARHDQRMPSRNW2D

A200001SSRFOIDHK
FT:/PPPO182752
A200001SSRFOIDHK
FT:/PPPO182752

A220101 004FHKNNNNNNNNNNNYNNN     
A220401 004FHKNNNNNNNNNNNYNNN     

A24010IEV PS X/MOW S7 PEE 195.00S7X/MOW PS IEV 170.00 NUC365.00END
ROE1.0 XT 136YK218YQ"
			);
			AssertFareSegments(
				365.00m, "NUC",
				a => a("KBP", "PS", "DME" ),
				a => a("DME", "S7", "PEE", 195.00m),
				a => a("PEE", "S7", "DME"),
				a => a("DME", "PS", "KBP",170.00m )
			);
		}

		[Test]
		public void TestParseTicketFares25()
		{
			ParseTicket(
@"T51G773392025520087221MAR131405 S7421SIBERIA AIRLINES        03APR13FE31E4FE2EF2
30FT30FT72321255 NBB0L8         30FTPLNPLAG20MAR1300121MAR13013
UAH0000000046250UAH00000000  00000000  00000000  00000000  00000000  000000000500               
NNNYN5NNYAYH NNNX   UA                             
000000001000004002000001000001001000002000000000

A02GRYNENKO/VOLODYMYRMR             080853338363226272673901000000670ADT   01  N
SI:GEN:GRYNENKO/VOLODYMYRMR                                   TL:25MAR13

A0402S7421SIBERIA AIRL4063M HK03APR0655 1015 2DMEMOSCOW/DOMODEMADMADRID       IND   X0   319    02126F AC:IBERIA      TK:YJT:05.20ANL:SIBERIA AIRLINES        ACL:IBERIA                  
A0403S7421SIBERIA AIRL4767M HK03APR1145 1255 2MADMADRID       ALCALICANTE/ALICDNG   O0   319 T4 00221F AC:IBERIA      TK:YJT:01.10ANL:SIBERIA AIRLINES        ACL:IBERIA                  
A0404S7421SIBERIA AIRL4770T HK07APR1735 1850 2ALCALICANTE/ALICMADMADRID       DNG   X0   319    00221F AC:IBERIA      TK:YJT:01.15ANL:SIBERIA AIRLINES        ACL:IBERIA                  
A0405S7421SIBERIA AIRL4066T HK07APR2310 0605 3MADMADRID       DMEMOSCOW/DOMODEINL   O0   319 T4S02126F AC:IBERIA      TK:YJT:04.55ANL:SIBERIA AIRLINES        ACL:IBERIA                  

A0501UT298UTAIR AVAITI 702H HK02APR1345 1615 2HRKKHARKIV      VKOMOSCOW/VNUKOV     
A0506UT298UTAIR AVAITI 701H HK08APR1150 1220 2VKOMOSCOW/VNUKOVHRKKHARKIV           

A0701EUR      447.00UAH        6475UAH        4625UAHT1:     421JDT2:     121QVT3:    1308XT
IT:     272YQ    1036YR

A080102MLEMADR 00000000       12FEB14      F:MLEMADR        E:S7 ONLY/REF/CHNG/RESTR                                      B:1PC
EF:S7 ONLY/REF/CHNG/RESTR
A080103MLEMADR 00000000       12FEB14      F:MLEMADR        E:S7 ONLY/REF/CHNG/RESTR                                      B:1PC
EF:S7 ONLY/REF/CHNG/RESTR
A080104TLEMADR 00000000       12FEB14      F:TLEMADR        E:S7 ONLY/REF/CHNG/RESTR                                      B:1PC
EF:S7 ONLY/REF/CHNG/RESTR
A080105TLEMADR 00000000       12FEB14      F:TLEMADR        E:S7 ONLY/REF/CHNG/RESTR                                      B:1PC
EF:S7 ONLY/REF/CHNG/RESTR

A09010MOW S7X/MAD S7 ALC 359.16S7X/MAD S7 MOW 222.52 NUC581.68END R
OE0.768453 XT 272YQ1036YR

A11S         6475N                                     P:01

A12HRKT *38 057 7194990-UNIVERSAL FLIGHTS-KHARKOV

A14VL-103620MARHDQRMS7THVJ3
A14VL-104320MARTJMRMUT4BSK7K

A24010MOW S7X/MAD S7 ALC 359.16S7X/MAD S7 MOW 222.52 NUC581.68END R
OE0.768453 XT 272YQ1036YR

A27N 01               UAH        6475
"
			);
			AssertFareSegments(
				581.68m, "NUC",
				a => a("DME", "S7", "MAD"),
				a => a("MAD", "S7", "ALC", 359.16m),
				a => a("ALC", "S7", "MAD"),
				a => a("MAD", "S7", "DME", 222.52m)
			);
		}

		[Test]
		public void TestParseTicketFares26()
		{
			ParseTicket(
@"AIR-BLK207;7A;;247;0100009613;1A1326991;001001
AMD 0103154375;1/1;              
GW3670692;1A1326991;IEV1A0985;AIR
MUC1A 7SG39B007;0101;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;IEVUW2100;72320220;;;;;;;;;;;;;;;;;;;;;;PS RLNDC 
A-UKRAINE INTL AIRLINES;PS 5666
B-TTP/RT/S3
C-7906/ 2710YDSU-1111SASU-I-5--
D-130101;130101;130101
G-X  ;;LONIEV;E1
H-004;003OLGW;LONDON GATWICK   ;KBP;KIEV BORYSPIL    ;PS    0502 R R 07FEB1220 1740 07FEB;OK01;HK01;L ;0;738;;;1PC;S ;;ET;0320 ;N;1355;GB;UA;F 
U-005X;002OKBP;KIEV BORYSPIL    ;LGW;LONDON GATWICK   ;PS    0501 Y Y 02JAN1000 1125 02JAN;RQ01;HL01;B ;0;738;;;;F ;;ET;0325 ;N;;1355;;UA;GB;S 
K-FGBP109.00     ;UAH1407       ;;;;;;;;;;;UAH1959       ;1.612383   ;7.9930     ;USD
KFTF; UAH232      YQ AC; UAH168      GB AD; UAH152      UB AS;;;;;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH232      YQ ;UAH168      GB ;UAH152      UB ;
L-
M-ROWGB          
N-NUC175.30
O-07FEB07FEB
Q-LON PS IEV175.30NUC175.30END ROE0.621791;FXB/S3
I-001;01STESHENKO/YELIZAVETA MRS;;APIEV 380 44 2067570 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
T-K566-2576233592
FDPAXZZ
FENONEND/REF REST/CHNG GBP50;S3;P1
FM*M*3;S3;P1
FPCASH
FVPS;S3;P1
TKTL01JAN/IEVUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX");
			AssertFareSegments(
				175.30m, "NUC",
				a => a("LGW", "PS", "KBP", 175.30m)
			);

			//CalculateFareSegments(100);
			AssertFareSegmentAmounts(
				175.30m
			);

		}

		[Test]
		public void TestParseTicketFares27()
		{
			ParseTicket(
@"T51G773392011180071303JAN130724 UT298UTAIR AVIATION          07JAN13FE854AFE2EF2
3KG05T7972321255 WG1S0A         3KG0KHYDPAG03JAN1300003JAN13010
UAH0000000014980UAH00000000  00000000  00000000  00000000  00000000  000000000100               
NNNYN5NNYAYH NNNX   UA                             
000000001000001000000001000001002000002000000000

A02MOREV/SERGEYMR                   003707043303263633185601000000633ADT   01  N
SI:GEN:MOREV/SERGEYMR                                         TL:03JAN13

A0401UT298UTAIR AVAITI 571K HK07JAN2120 0605 3VKOMOSCOW/VNUKOVKJAKRASNOYARSK  DN    O0   738  A 02092F TK:YJT:04.45ANL:UTAIR AVAITION          

A0701RUB        5690UAH        1676UAH        1498UAHT1:     178YQ

A080101KSALEOW 00000000                    F:KSALEOW        B:20K

A09010MOW UT KJA 5690 RUB5690END

A11S         1676N                                     P:01

A12IEVT *380 57 732 04 71-XKC GROUP-KHARKIV
A12HRKM *095 92 72 3 94 DMITRIY

A14SA-PCC:3KG0-NAME:XKC GROUP
A14VL-072003JANTJMRMUT473ZMF

A200001SSRFOIDHK
FT:/PPCA216584

A24010MOW UT KJA 5690 RUB5690END

A27N 01               UAH        1676");
			AssertFareSegments(
				5690m, "RUB",
				a => a("VKO", "UT", "KJA", 5690m)
			);

			//CalculateFareSegments(100);
			AssertFareSegmentAmounts(
				5690m
			);

		}

		[Test]
		public void TestParseTicketFares28()
		{
			ParseTicket(
@"T51G773392022900063905DEC121701 SU555AEROFLOT RUSSIAN AIRLINE15JAN13FE854AFE2EF2
5T755T7972321255 N6HDBW         5T75NDYDPAG04DEC1200105DEC12009
UAH0000000059550UAH00000000  00000000  00000000  00000000  00000000  000000000100               
NNNYN5NYYAYH NNNX   UA                             
000000001000004000000001000001002000002000000000

A02TIMOFYEYEV/VOLODYMYRMR           340638068352263633177802000000566ADT   01  N
SI:GEN:TIMOFYEYEV/VOLODYMYRMR                                 TL:05DEC12

A0401SU555AEROFLOT RUS1801T HK15JAN1530 1900 2KBPKIEV/BORYSPILSVOMOSCOW/SHEREMINL   X0   321  B 00481F TK:YJT:01.30ANL:AEROFLOT RUSSIAN AIRLINE
A0402SU555AEROFLOT RUS 290T HK15JAN2050 0855 3SVOMOSCOW/SHEREMHANHANOI        IND   O0   333  D 04199F TK:YJT:09.05ANL:AEROFLOT RUSSIAN AIRLINE
A0403SU555AEROFLOT RUS 293L HK28JAN1105 1845 2SGNHO CHI MINH CSVOMOSCOW/SHEREMINL   X0   763 T2 04806F TK:YJT:10.40ANL:AEROFLOT RUSSIAN AIRLINE
A0404SU555AEROFLOT RUS1802L HK28JAN2150 2130 2SVOMOSCOW/SHEREMKBPKIEV/BORYSPILINL   O0   321  F 00481F TK:YJT:01.40ANL:AEROFLOT RUSSIAN AIRLINE

A0701USD      745.00UAH        8323UAH        5955UAHT1:      32UAT2:      16UDT3:    2320XT
IT:     136YK     144JC     156YR    1884YQ

A080101TEX     0000000015JAN1315JAN13      F:TEX            E:VALID ON SU/FARE RESTR APL                                  B:1PC
EF:VALID ON SU/FARE RESTR APL
A080102TEX     0000000015JAN1315JAN13      F:TEX            E:VALID ON SU/FARE RESTR APL                                  B:1PC
EF:VALID ON SU/FARE RESTR APL
A080103LPX     0000000028JAN1328JAN13      F:LPX            E:VALID ON SU/FARE RESTR APL                                  B:1PC
EF:VALID ON SU/FARE RESTR APL
A080104LPX     0000000028JAN1328JAN13      F:LPX            E:VALID ON SU/FARE RESTR APL                                  B:1PC
EF:VALID ON SU/FARE RESTR APL

A09010IEV SU X/MOW SU HAN 495.00/-SGN SU X/MOW SU IEV 250.00 NUC745
.00END ROE1.0 XT 136YK144JC156YR1884YQ

A11S         8323N                                     P:01

A12HRKT *38 067 474 11 77 GALLERYTOUR
A12HRKM *097 992 49 40

A14SA-PCC:5T75-NAME:KOBALADZE FOP
A14VL-124904DECHDQRMSUIWTCGO

A24010IEV SU X/MOW SU HAN 495.00/-SGN SU X/MOW SU IEV 250.00 NUC745
.00END ROE1.0 XT 136YK144JC156YR1884YQ

A27N 01               UAH        8323"
			);
			AssertFareSegments(
				745.00m, "NUC",
				a => a("KBP", "SU", "SVO"),
				a => a("SVO", "SU", "HAN", 495.00m),
				a => a("SGN", "SU", "SVO"),
				a => a("SVO", "SU", "KBP", 250.00m)
			);

		}

		[Test]
		public void TestParseTicketFares29()
		{
			ParseTicket(
@"T51G773392013060204719APR131222 HR169HAHN AIR LINES          24APR13FE4512FE2EF2
71Q371Q372320220 J3T60D         71Q3DSYDSAG19APR1300019APR13009
UAH0000000028380UAH00000000  00000000  00000000  00000000  00000000  000000000000               
NNNYN7NNYAYA NNN    UA                             
000000001000002000000001000000001000001000000000

A02NIKOLENKO/OLENAMRS                          3          00         ADT   01  N
TL:22APR13

A0401Z6181DNIEPROAVIA    1Y HK24APR0940 1040 2KBPKIEV/BORYSPILDNKDNIPROPETROVSDN    O0   ER4  B 00245F TK:NJT:01.00ANL:DNIEPROAVIA JSA         
A0402Z6181DNIEPROAVIA    8W HK24APR1900 2000 2DNKDNIPROPETROVSKBPKIEV/BORYSPILDN    O0   ER4    00245F TK:NJT:01.00ANL:DNIEPROAVIA JSA         

A0701USD      355.00UAH        3820UAH        2838UAHT1:      24UAT2:       8UDT3:     950XT
IT:      60YK     586HF     304YQ

A080101YRT     00000000       24OCT13      F:YRT            E:NON ENDO/REF RESTR/          E:RBK FREE                     B:20K
A080102WRT6M   0000000024APR1324APR13      F:WRT6M          E:NON ENDO/REF RESTR/          E:RBK FREE                     B:20K

A09010IEV Z6 DNK 210.00Z6 IEV 145.00 USD355.00END XT 60YK586HF304YQ

A12IEVT *38 044 206 75 70

A14VL-122119APRHDQRMZ6NHWCJ

A24010IEV Z6 DNK 210.00Z6 IEV 145.00 USD355.00END XT 60YK586HF304YQ"
			);
			AssertFareSegments(
				355.00m, "USD",
				a => a("KBP", "Z6", "DNK", 210.00m),
				a => a("DNK", "Z6", "KBP", 145.00m)
			);
		}

		[Test]
		public void TestParseTicketFares30()
		{
			ParseTicket(
@"T51G773392013560033201MAY130727 HR169HAHN AIR LINES          04MAY13FE7992FE2EF2
7E8F5L7R72320220 L826PK         7E8FRNYDPAG01MAY1300001MAY13011
UAH0000000029980UAH00000000  00000000  00000000  00000000  00000000  000000000000               
NNNYN5NNYAYH NNNX   UA                             
000000002000002000000001000001001000002000000000

A02UDOVYCHENKO/IEVGENMR             121529392333204671943401000000334ADT   01  N
TL:04MAY13
A02UDOVYCHENKO/IRYNAMRS             121529393363204671943501000000334ADT   01  N
TL:04MAY13

A0401AT147ROYAL AIR MA 431U HK04MAY2230 2330 2CMNCASABLANCA   AGAAGADIR       DN    O0   73G T1 00246F TK:YJT:01.00ANL:ROYAL AIR MAROC         
A0402AT147ROYAL AIR MA 426U HK13MAY2040 2155 2AGAAGADIR       CMNCASABLANCA   DN    O0   AT7    00246F TK:YJT:01.15ANL:ROYAL AIR MAROC         

A0701MAD        1600UAH        1614UAH        1499UAHT1:     115MA

A080101URTD    0000000004MAY1304MAY13      F:URTD           E:NONREF/SPEX                  E:NO ENDOS/AT ONLY             B:1PC
A080102URTD    0000000013MAY1313MAY13      F:URTD           E:NONREF/SPEX                  E:NO ENDOS/AT ONLY             B:1PC

A09010CAS AT AGA Q240 560 AT CAS Q240 560 MAD1600END

A11S         3228N                                     

A12IEVT *380 44 581 33 99 --E TRAVELS--

A14SA-PCC:7E8F-NAME:I TRAVELS
A14VL-065801MAYMUCRM1AYUTG7F"
			);
			AssertFareSegments(
				1600.00m, "MAD",
				a => a("CMN", "AT", "AGA", 560.00m, 240m),
				a => a("AGA", "AT", "CMN", 560.00m, 240m)
			);
		}

		[Test]
		public void TestParseTicketFares31()
		{
			ParseTicket(
@"AIR-BLK207;7A;;267;1500031050;1A1326991;001001
AMD 1503572946;1/1;              
GW3714354;1A1326991;IEV1A0985;AIR
MUC1A 76RYA6018;0101;HRKUW2100;72321255;HRKUW2100;72321255;HRKUW2100;72321255;HRKUW2100;72321255;;;;;;;;;;;;;;;;;;;;;;EK MJBFQS;FZ YJJSW1;9W CSCBBT
A-JET AIRWAYS;9W 5891
B-TTP/RT/S4-5
C-7906/ 1971PLSU-1971PLSU-I-0--
D-130514;130515;130515
G-   ;;DELDEL;IN
H-017;004ODEL;DELHI            ;RPR;RAIPUR           ;9W    2531 L L 22MAY1610 1755 22MAY;OK01;HK01;F ;0;73W;;JETKONNECT;15K;3 ;;ET;0145 ; ;585;IN;IN;  
Y-017;004DEL;DELHI;RPR;RAIPUR;;;;;;;73W;N
H-018;005ORPR;RAIPUR           ;DEL;DELHI            ;9W    2532 B B 22JUL1825 2020 22JUL;OK01;HK01;F ;0;73W;;JETKONNECT;15K;;;ET;0155 ; ;585;IN;IN;3 
Y-018;005RPR;RAIPUR;DEL;DELHI;;;;;;;73W;N
U-001X;002OHRK;KHARKIV OSNOVA IN;DXB;DUBAI            ;FZ    0726 V V 21MAY1410 1940 21MAY;OK01;HK01;;0;73H;;;;;;ET;0430 ;N;;1989;;UA;AE;2 
U-002X;003ODXB;DUBAI            ;DEL;DELHI            ;EK    0510 U U 22MAY0435 0925 22MAY;OK01;HK01;M ;0;772;;;;3 ;;ET;0320 ;N;;1362;;AE;IN;3 
U-019X;006ODEL;DELHI            ;DXB;DUBAI            ;EK    0513 U U 23JUL0415 0610 23JUL;OK01;HK01;M ;0;773;;;;3 ;;ET;0325 ;N;;1362;;IN;AE;3 
U-006X;007ODXB;DUBAI            ;HRK;KHARKIV OSNOVA IN;FZ    0725 V V 23JUL0900 1300 23JUL;OK01;HK01;;0;73H;;;;2 ;;ET;0500 ;N;;1989;;AE;UA;  
K-FINR6600       ;UAH960        ;;;;;;;;;;;UAH1939       ;0.018236   ;7.9930     ;USD
KFTF; UAH628      YQ AC; UAH16       YR VA; UAH87       IN CO; UAH80       JN DC; UAH17       YM DE; UAH74       IN EA; UAH77       WO RE;;;;;;;;;;;;;;;;;;;;;;;
TAX-UAH628      YQ ;UAH16       YR ;UAH335      XT ;
L-*9W *
M-L2IPJK         ;B2A60BJK       
N-INR9;
O-22MAY22MAY;22JUL22JUL
Q-DEL 9W RPR6400 9W DEL200INR6600END XT87IN80JN17YM74IN77WO;FXB/R,VC-9W/S4-5
I-001;01OLIINYK/VLADYSLAV MR;;APHRK +38057-7194990 - UNIVERSAL FLIGHTS SALES AGENCY - A;;
SSR DOCS 9W  HK1/P/UKR/EK322787/UKR/16MAY90/M/08JUL19/OLIINYK/VLADYSLAV/H;S4;P1
SSR DOCS 9W  HK1/P/UKR/EK322787/UKR/16MAY90/M/08JUL19/OLIINYK/VLADYSLAV/H;S5;P1
T-K589-3532622456
FENON ENDO;S4-5;P1
FM*M*1;S4-5;P1
FPCASH
FV9W;S4-5;P1
TKTL15MAY/HRKUW2100
RM !ATTN! DOCS ON ALL INTERNATIONAL FLIGHTS REQUIRED!!
ENDX"
			);
			AssertFareSegments(
				6600.00m, "INR",
				a => a("DEL", "9W", "RPR", 6400.00m),
				a => a("RPR", "9W", "DEL", 200.00m)
			);
		}

		[Test]
		public void TestParseTicketFares32()
		{
			ParseTicket(
@"T51G773392018090085204MAR130914 LO080LOT POLISH AIRLINES     21MAR13FE854AFE2EF2
3Y665T7972321255 Q3ZH46         3Y66KTYDPAG22FEB1301004MAR13042
UAH0000000040780UAH00000000  00000000  00000000  00000000  00000000  000000000500               
NNNYN5NNYAYH NNNX   UA                             
000000002000002000000001000001001000002000000000

A02TERSTEPANYAN/EMILMR              063777520313329771128901000000761ADT   01  N
SI:GEN:TERSTEPANYAN/EMILMR                                    TL:04MAR13
A02TERSTEPANIAN/OLENAMRS            063777521343329771129001000000761ADT   01  N
SI:GEN:TERSTEPANIAN/OLENAMRS                                  TL:04MAR13

A0401LO080LOT POLISH A 752T HK21MAR1440 1515 2KBPKIEV/BORYSPILWAWWARSAW       INS   O0   E95  D 00428F TK:YJT:01.35ANL:LOT POLISH AIRLINES     
A0402LO080LOT POLISH A 751T HK23MAR1115 1350 2WAWWARSAW       KBPKIEV/BORYSPILINS   O0   E95    00428F TK:YJT:01.35ANL:LOT POLISH AIRLINES     

A0701USD      255.00UAH        2777UAH        2039UAHT1:      32UAT2:      16UDT3:     690XT
IT:     136YK       3ND     151XW     400YQ

A080101TGREY24 0000000021MAR1321MAR13      F:TGREY24        E:REF/RES RESTRICTIONS APPLY                                  B:1PC
EF:REF/RES RESTRICTIONS APPLY
A080102TGREY24 0000000023MAR1323MAR13      F:TGREY24        E:REF/RES RESTRICTIONS APPLY                                  B:1PC
EF:REF/RES RESTRICTIONS APPLY

A09010IEV LO WAW 127.50LO IEV 127.50 UC255.00END ROE1.0 XT 136YK3N
D151XW400YQ

A11S         5554N                                     

A12IEVT *380577142333-ELIT TOURISM LTD-KHARKIV

A14SA-PCC:3Y66-NAME:ELIT TOURISM LTD
A14VL-083301MARMUCRM1A7VMPIW

A24010IEV LO WAW 127.50LO IEV 127.50 NUC255.00END ROE1.0 XT 136YK3N
D151XW400YQ

A27N 01               UAH        2777
A27N 01               UAH        2777"
			);
			AssertFareSegments(
				255.00m, "NUC",
				a => a("KBP", "LO", "WAW", 127.50m),
				a => a("WAW", "LO", "KBP", 127.50m)
			);
		}

		[Test]
		public void TestParseTicketFares33()
		{
			ParseTicket(
@"T51G773392018220277704JUL131328 PS566UKRAINE INTERNATIONAL AI06JUL13B80708FE2EF2
71Q371Q372320220 LKB858         079517N17AG04JUL1300004JUL13011
UAH0000000029110UAH00000000  00000000  00000000  00000000  00000000  000000000300               
NNNYN5NNYAYA NNNX   UA                             
000000001000003000000001000001002000002000000000

A02NARGIZYAN/GHAZAROSMR                        3416652225001         ADT   01  N
TL:06JUL13

A0401PS566UKRAINE INTE 616R HK06JUL0155 0320 2EVNYEREVAN      ODSODESA        INM   O0   735    00819F TK:YJT:02.25ANL:UKRAINE INTERNATIONAL AI
A0402PS566UKRAINE INTE  56K HK10JUL0700 0800 2ODSODESA        KBPKIEV/BORYSPILDNN   X0   73N    00270F TK:YJT:01.00ANL:UKRAINE INTERNATIONAL AI
A0403PS566UKRAINE INTE 991K HK10JUL0940 1230 2KBPKIEV/BORYSPILBCNBARCELONA    INL   O0   321  D 01493F TK:YJT:03.50ANL:UKRAINE INTERNATIONAL AI

A0701EUR      281.00UAH        4121UAH        2911UAHT1:      48UAT2:      20UDT3:    1142XT
IT:     164YK     198AM     228KC     552YQ

A080101RPROMAM 0000000006JUL1306JUL13      F:RPROMAM        E:NONEND/REF ANS CHNG RESTR    E:NONEND/REF AND CHNG RESTR    B:1PC
A080102KPXUA1  0000000010JUL1310JUL13      F:KPXUA1         E:NONEND/REF ANS CHNG RESTR    E:NONEND/REF AND CHNG RESTR    B:1PC
A080103KPXUA1  0000000010JUL1310JUL13      F:KPXUA1         E:NONEND/REF ANS CHNG RESTR    E:NONEND/REF AND CHNG RESTR    B:1PC

A09010EVN PS ODS 184.07PS X/IEV PS BCN 184.50 NUC368.57END ROE0.760
562XUA1   XT 164YK198AM228KC552YQ

A11S         4121N                                     P:01

A12IEVT *38 044 206 75 70
A12MANE 82//HOTMAIL.ES

A14X*//-P1/SSRDOCSPSHK1/P/AM/AN0423766/AM/15JUN77/M/29MAR23/NARGIZYAN/GHAZAROS-//
A14VL-081804JULHDQRMPSRMYWH

A24010EVN PS ODS 184.07PS X/IEV PS BCN 184.50 NUC368.57END ROE0.760
562XUA1   XT 164YK198AM228KC552YQ"
			);
			AssertFareSegments(
				368.57m, "NUC",
				a => a("EVN", "PS", "ODS", 184.07m),
				a => a("ODS", "PS", "KBP"),
				a => a("KBP", "PS", "BCN", 184.50m)
			);
		}

		#endregion


		#region Fare Segment  Utils

		public delegate FlightSegment FareSegmentAssertEvent(
			string fromAirportCode,
			string carrierCode,
			string toAirportCode,
			decimal? fare = null,
			decimal? surcharges = null,
			decimal? stopoverOrTransferCharge = null,
			bool isInclusive = false,
			double? setDistance = null,
			Action<FlightSegment> action = null
		);

		private FlightSegment AssertFareSegment(
			string fromAirportCode,
			string carrierCode,
			string toAirportCode,
			decimal? fare = null,
			decimal? surcharges = null,
			decimal? stopoverOrTransferCharge = null,
			bool isInclusive = false,
			double? setDistance = null,
			Action<FlightSegment> action = null
		)
		{
			var msg = "FareSegment[" + _fareSegmentIndex + "].";
			Assert.AreEqual(fromAirportCode, _segment.FromAirportCode, msg + "FromAirportCode");
			Assert.AreEqual(carrierCode, _segment.CarrierIataCode, msg + "CarrierCode");
			Assert.AreEqual(toAirportCode, _segment.ToAirportCode, msg + "ToAirportCode");

			Assert.AreEqual(fare, _segment.Fare, msg + "Fare");
			Assert.AreEqual(surcharges, _segment.Surcharges, msg + "Surcharges");
			Assert.AreEqual(stopoverOrTransferCharge, _segment.StopoverOrTransferCharge, msg + "StopoverOrTransferCharge");

			Assert.AreEqual(isInclusive, _segment.IsInclusive, msg + "IsInclusive");

			if (setDistance != null)
				_segment.Distance = setDistance.Value;

			if (action != null)
				action(_segment);

			return _segment;
		}

		public void AssertFareSegments(
			decimal? fareTotal,
			string currencyCode,
			params Action<FareSegmentAssertEvent>[] asserts)
		{

			var fareSegments = GetFareSegments();

			Assert.AreEqual(asserts.Length, fareSegments.Count, "FareSegments.Count");

			_fareSegmentIndex = 0;
			foreach (var assert in asserts)
			{
				_segment = fareSegments[_fareSegmentIndex];
				assert(AssertFareSegment);
				_fareSegmentIndex++;
			}


			if (string.IsNullOrEmpty(currencyCode))
				Assert.IsTrue(ticket.FareTotal == null || ticket.FareTotal.Currency == null || string.IsNullOrEmpty(ticket.FareTotal.Currency.Code));
			else
			{
				Assert.IsNotNull(ticket.FareTotal, "FareTotal");
				Assert.AreEqual(fareTotal, ticket.FareTotal.Amount, "FareTotal.Amount");
				Assert.AreEqual(currencyCode, ticket.FareTotal.Currency.Code, "FareTotal.Currency");
			}
		}

		public AviaTicket ParseTicket(string documentContent)
		{
			var docs = documentContent.StartsWith("AIR-")
				? AirParser.Parse(documentContent, new Currency("UAH"))
				: MirParser.Parse(documentContent, new Currency("UAH"));

			Assert.GreaterOrEqual(docs.Count, 1);

			return ticket = (AviaTicket)docs[0];
		}


		private AviaTicket ticket;
		private FlightSegment _segment;
		private int _fareSegmentIndex;


		private List<FlightSegment> GetFareSegments()
		{
			return ticket.Segments.Where(a => a.Type == 0).ToList();
		}


		//public void CalculateFareSegments(params double[] distances)
		//{
		//	var fareSegments = GetFareSegments();

		//	for (var i = 0; i < distances.Length; i++)
		//	{
		//		fareSegments[i].Distance = distances[i];
		//	}

		//	ticket.CalculateFares();
		//}

		public void AssertFareSegmentAmounts(params decimal[] amounts)
		{
			var fareSegments = GetFareSegments();

			for (var i = 0; i < amounts.Length; i++)
			{
				var msg = "FareSegment[" + i + "].";
				var seg = fareSegments[i];
				Assert.AreEqual(amounts[i], seg.Amount.Amount, msg + "Amount");
				//Assert.AreEqual(ticket.FareTotal.Currency.Code, seg.Amount.Currency.Code, msg + "Amount");
			}

			//if (ticket.FareTotal != null && ticket.FareTotal.Amount > 0)
			//	Assert.AreEqual(amounts.Sum(), ticket.FareTotal.Amount);
		}


		#endregion
	}
}